+++
date = '2026-01-06T18:55:14+08:00'
draft = true
title = 'My_first_essay'
math = true
image = 'cover.jpeg'
+++

## 前情提要

导师让我发一篇期刊，参考论文和代码都有，让我改。时间所剩不多大概两个礼拜。不管怎样，先拆解一下任务。

- [ ] 改代码
- [ ] 写论文


## 改代码

主要的修改思路是修改特征提取部分，让模型提取更多的语义信息以期提高模型的整体性能。具体来说是在原特征提取分支的基础上添加两个特征提取分支SAW2和Dinov2。听起来挺简单的，但具体操作还是不容易。先分析原始特征提取分支的输入输出吧。

### input

网络的输入可以从数据加载 (loading_data.py, SHHA.py) 和处理流程 (engine.py, collate_fn) 中推断出来。

简而言之，DSGCNet 网络的输入是一个标准的 4D PyTorch 张量，包含了一批经过预处理和归一化的 RGB 图像。

具体输入格式
1. 训练阶段 (Training)
在训练时，网络接收的输入张量形状通常为：

$$(B \times 4, 3, 128, 128)$$

* B (Batch Size): 由 train.py 中的 --batch_size 参数控制（默认 8）。
* 4 (Num Patches): 数据加载通过 random_crop 将每张原始图像裁剪为 4 个 patches。collate_fn_crowd_train 会将这 4 个 patch 展平并入 Batch 维度。
* 3 (Channels): RGB 通道。
* 128×128 (Resolution): 训练时使用固定大小的随机裁剪（在 SHHA.py 中硬编码为 128）。
> 随机裁剪的目的：从一张大图中随机裁剪 4 个不同的区域，相当于增加了训练数据的多样性。这有助于模型学习局部特征，防止过拟合，并提高模型对不同密度分布区域的鲁棒性。

数据类型: Float32。归一化: 使用 ImageNet 标准均值和方差：
Mean: [0.485, 0.456, 0.406]
Std: [0.229, 0.224, 0.225]

2. 测试/评估阶段 (Evaluation)
在评估时，通常 batch_size 设为 1（因为图像分辨率不一），输入形状为：

$$(1, 3, H, W)$$

* H,W: 原始图像的高度和宽度（为了处理不同尺寸，通常使用 Padding 或 Batch Size=1）。
> 注意: 这里的 H 和 W 会被处理成 128 的倍数（通过 padding），这在 misc.py 的 nested_tensor_from_tensor_list 中处理。

辅助输入 (用于 Loss 计算)
虽然网络前向传播 (model(samples)) 只接收图像张量，但在训练循环 (engine.py) 中，还需要以下数据来计算损失：
* Ground Truth Density Map (gt_dmap): 形状对应于输入图像，用于监督 Density Approximation 分支。
* Point Annotations (targets): 包含人员坐标点
(point)，用于监督 Representation Approximation 分支和分类/回归损失。

### Net info

![DSGCNet_architecture](DSGCNet_architecture.png "DSGCNet_architecture") 

运行下面的脚本，查看输入数据在网络中的流动情况

```python
import torch
from torchinfo import summary
from models.DSGCnet import DSGCnet
from models.backbone import Backbone_VGG

if __name__ == "__main__":
    device = "cuda" if torch.cuda.is_available() else "cpu"
    input = torch.randn((1, 3, 128, 128)).to(device)
    backbone = Backbone_VGG("vgg16_bn", True).to(device)
    dsgc_net = DSGCnet(backbone).to(device)
    summary(dsgc_net, input_data=input)

```

输出如下:
```text
==========================================================================================
Layer (type:depth-idx)                   Output Shape              Param #
==========================================================================================
DSGCnet                                  [1, 1, 16, 16]            197,378
├─Backbone_VGG: 1-1                      [1, 128, 64, 64]          --
│    └─Sequential: 2-1                   [1, 128, 64, 64]          --
│    │    └─Conv2d: 3-1                  [1, 64, 128, 128]         1,792
│    │    └─BatchNorm2d: 3-2             [1, 64, 128, 128]         128
│    │    └─ReLU: 3-3                    [1, 64, 128, 128]         --
│    │    └─Conv2d: 3-4                  [1, 64, 128, 128]         36,928
│    │    └─BatchNorm2d: 3-5             [1, 64, 128, 128]         128
│    │    └─ReLU: 3-6                    [1, 64, 128, 128]         --
│    │    └─MaxPool2d: 3-7               [1, 64, 64, 64]           --
│    │    └─Conv2d: 3-8                  [1, 128, 64, 64]          73,856
│    │    └─BatchNorm2d: 3-9             [1, 128, 64, 64]          256
│    │    └─ReLU: 3-10                   [1, 128, 64, 64]          --
│    │    └─Conv2d: 3-11                 [1, 128, 64, 64]          147,584
│    │    └─BatchNorm2d: 3-12            [1, 128, 64, 64]          256
│    │    └─ReLU: 3-13                   [1, 128, 64, 64]          --
│    └─Sequential: 2-2                   [1, 256, 32, 32]          --
│    │    └─MaxPool2d: 3-14              [1, 128, 32, 32]          --
│    │    └─Conv2d: 3-15                 [1, 256, 32, 32]          295,168
│    │    └─BatchNorm2d: 3-16            [1, 256, 32, 32]          512
│    │    └─ReLU: 3-17                   [1, 256, 32, 32]          --
│    │    └─Conv2d: 3-18                 [1, 256, 32, 32]          590,080
│    │    └─BatchNorm2d: 3-19            [1, 256, 32, 32]          512
│    │    └─ReLU: 3-20                   [1, 256, 32, 32]          --
│    │    └─Conv2d: 3-21                 [1, 256, 32, 32]          590,080
│    │    └─BatchNorm2d: 3-22            [1, 256, 32, 32]          512
│    │    └─ReLU: 3-23                   [1, 256, 32, 32]          --
│    └─Sequential: 2-3                   [1, 512, 16, 16]          --
│    │    └─MaxPool2d: 3-24              [1, 256, 16, 16]          --
│    │    └─Conv2d: 3-25                 [1, 512, 16, 16]          1,180,160
│    │    └─BatchNorm2d: 3-26            [1, 512, 16, 16]          1,024
│    │    └─ReLU: 3-27                   [1, 512, 16, 16]          --
│    │    └─Conv2d: 3-28                 [1, 512, 16, 16]          2,359,808
│    │    └─BatchNorm2d: 3-29            [1, 512, 16, 16]          1,024
│    │    └─ReLU: 3-30                   [1, 512, 16, 16]          --
│    │    └─Conv2d: 3-31                 [1, 512, 16, 16]          2,359,808
│    │    └─BatchNorm2d: 3-32            [1, 512, 16, 16]          1,024
│    │    └─ReLU: 3-33                   [1, 512, 16, 16]          --
│    └─Sequential: 2-4                   [1, 512, 8, 8]            --
│    │    └─MaxPool2d: 3-34              [1, 512, 8, 8]            --
│    │    └─Conv2d: 3-35                 [1, 512, 8, 8]            2,359,808
│    │    └─BatchNorm2d: 3-36            [1, 512, 8, 8]            1,024
│    │    └─ReLU: 3-37                   [1, 512, 8, 8]            --
│    │    └─Conv2d: 3-38                 [1, 512, 8, 8]            2,359,808
│    │    └─BatchNorm2d: 3-39            [1, 512, 8, 8]            1,024
│    │    └─ReLU: 3-40                   [1, 512, 8, 8]            --
│    │    └─Conv2d: 3-41                 [1, 512, 8, 8]            2,359,808
│    │    └─BatchNorm2d: 3-42            [1, 512, 8, 8]            1,024
│    │    └─ReLU: 3-43                   [1, 512, 8, 8]            --
├─Decoder_SPD_PAFPN: 1-2                 [1, 256, 16, 16]          --
│    └─Sequential: 2-5                   [1, 256, 8, 8]            --
│    │    └─Conv2d: 3-44                 [1, 256, 8, 8]            131,328
│    │    └─BatchNorm2d: 3-45            [1, 256, 8, 8]            512
│    │    └─ReLU: 3-46                   [1, 256, 8, 8]            --
│    └─Upsample: 2-6                     [1, 256, 16, 16]          --
│    └─Sequential: 2-7                   [1, 256, 8, 8]            --
│    │    └─Conv2d: 3-47                 [1, 256, 8, 8]            590,080
│    │    └─BatchNorm2d: 3-48            [1, 256, 8, 8]            512
│    │    └─ReLU: 3-49                   [1, 256, 8, 8]            --
│    └─Sequential: 2-8                   [1, 256, 16, 16]          --
│    │    └─Conv2d: 3-50                 [1, 256, 16, 16]          131,328
│    │    └─BatchNorm2d: 3-51            [1, 256, 16, 16]          512
│    │    └─ReLU: 3-52                   [1, 256, 16, 16]          --
│    └─Upsample: 2-9                     [1, 256, 32, 32]          --
│    └─Sequential: 2-10                  [1, 256, 16, 16]          --
│    │    └─Conv2d: 3-53                 [1, 256, 16, 16]          590,080
│    │    └─BatchNorm2d: 3-54            [1, 256, 16, 16]          512
│    │    └─ReLU: 3-55                   [1, 256, 16, 16]          --
│    └─Sequential: 2-11                  [1, 256, 32, 32]          --
│    │    └─Conv2d: 3-56                 [1, 256, 32, 32]          65,792
│    │    └─BatchNorm2d: 3-57            [1, 256, 32, 32]          512
│    │    └─ReLU: 3-58                   [1, 256, 32, 32]          --
│    └─Sequential: 2-12                  [1, 256, 32, 32]          --
│    │    └─Conv2d: 3-59                 [1, 256, 32, 32]          590,080
│    │    └─BatchNorm2d: 3-60            [1, 256, 32, 32]          512
│    │    └─ReLU: 3-61                   [1, 256, 32, 32]          --
│    └─Sequential: 2-13                  [1, 256, 16, 16]          --
│    │    └─SPD: 3-62                    [1, 1024, 16, 16]         --
│    │    └─Conv2d: 3-63                 [1, 256, 16, 16]          262,400
│    │    └─BatchNorm2d: 3-64            [1, 256, 16, 16]          512
│    │    └─ReLU: 3-65                   [1, 256, 16, 16]          --
│    └─Sequential: 2-14                  [1, 256, 16, 16]          (recursive)
│    │    └─Conv2d: 3-66                 [1, 256, 16, 16]          (recursive)
│    │    └─BatchNorm2d: 3-67            [1, 256, 16, 16]          (recursive)
│    │    └─ReLU: 3-68                   [1, 256, 16, 16]          --
│    └─Sequential: 2-15                  [1, 256, 8, 8]            --
│    │    └─SPD: 3-69                    [1, 1024, 8, 8]           --
│    │    └─Conv2d: 3-70                 [1, 256, 8, 8]            262,400
│    │    └─BatchNorm2d: 3-71            [1, 256, 8, 8]            512
│    │    └─ReLU: 3-72                   [1, 256, 8, 8]            --
│    └─Sequential: 2-16                  [1, 256, 8, 8]            (recursive)
│    │    └─Conv2d: 3-73                 [1, 256, 8, 8]            (recursive)
│    │    └─BatchNorm2d: 3-74            [1, 256, 8, 8]            (recursive)
│    │    └─ReLU: 3-75                   [1, 256, 8, 8]            --
│    └─Upsample: 2-17                    [1, 256, 16, 16]          --
│    └─Sequential: 2-18                  [1, 256, 16, 16]          --
│    │    └─Conv2d: 3-76                 [1, 256, 16, 16]          196,864
│    │    └─BatchNorm2d: 3-77            [1, 256, 16, 16]          512
│    │    └─ReLU: 3-78                   [1, 256, 16, 16]          --
├─Density_pred: 1-3                      [1, 1, 16, 16]            --
│    └─Sequential: 2-19                  [1, 256, 16, 16]          --
│    │    └─Conv2d: 3-79                 [1, 256, 16, 16]          590,080
│    │    └─BatchNorm2d: 3-80            [1, 256, 16, 16]          512
│    │    └─ReLU: 3-81                   [1, 256, 16, 16]          --
│    └─Sequential: 2-20                  [1, 256, 16, 16]          --
│    │    └─Conv2d: 3-82                 [1, 256, 16, 16]          590,080
│    │    └─BatchNorm2d: 3-83            [1, 256, 16, 16]          512
│    │    └─ReLU: 3-84                   [1, 256, 16, 16]          --
│    └─Sequential: 2-21                  [1, 256, 16, 16]          --
│    │    └─Conv2d: 3-85                 [1, 256, 16, 16]          590,080
│    │    └─BatchNorm2d: 3-86            [1, 256, 16, 16]          512
│    │    └─ReLU: 3-87                   [1, 256, 16, 16]          --
│    └─Sequential: 2-22                  [1, 1, 16, 16]            --
│    │    └─Conv2d: 3-88                 [1, 128, 16, 16]          295,040
│    │    └─BatchNorm2d: 3-89            [1, 128, 16, 16]          256
│    │    └─ReLU: 3-90                   [1, 128, 16, 16]          --
│    │    └─Conv2d: 3-91                 [1, 64, 16, 16]           73,792
│    │    └─BatchNorm2d: 3-92            [1, 64, 16, 16]           128
│    │    └─ReLU: 3-93                   [1, 64, 16, 16]           --
│    │    └─Conv2d: 3-94                 [1, 1, 16, 16]            65
│    │    └─ReLU: 3-95                   [1, 1, 16, 16]            --
├─DensityGCNProcessor: 1-4               [1, 256, 16, 16]          --
│    └─GCNModel: 2-23                    [256, 256]                --
│    │    └─GCNConv: 3-96                [256, 512]                131,584
│    │    └─GCNConv: 3-97                [256, 256]                131,328
├─FeatureGCNProcessor: 1-5               [1, 256, 16, 16]          --
│    └─GCNModel: 2-24                    [256, 256]                --
│    │    └─GCNConv: 3-98                [256, 512]                131,584
│    │    └─GCNConv: 3-99                [256, 256]                131,328
├─RegressionModel: 1-6                   [1, 1024, 2]              1,180,160
│    └─Conv2d: 2-25                      [1, 256, 16, 16]          590,080
│    └─ReLU: 2-26                        [1, 256, 16, 16]          --
│    └─Conv2d: 2-27                      [1, 256, 16, 16]          590,080
│    └─ReLU: 2-28                        [1, 256, 16, 16]          --
│    └─Conv2d: 2-29                      [1, 8, 16, 16]            18,440
├─ClassificationModel: 1-7               [1, 1024, 2]              1,180,160
│    └─Conv2d: 2-30                      [1, 256, 16, 16]          590,080
│    └─ReLU: 2-31                        [1, 256, 16, 16]          --
│    └─Conv2d: 2-32                      [1, 256, 16, 16]          590,080
│    └─ReLU: 2-33                        [1, 256, 16, 16]          --
│    └─Conv2d: 2-34                      [1, 8, 16, 16]            18,440
├─AnchorPoints: 1-8                      [1, 1024, 2]              --
==========================================================================================
Total params: 25,169,875
Trainable params: 25,169,875
Non-trainable params: 0
Total mult-adds (G): 7.54
==========================================================================================
Input size (MB): 0.20
Forward/backward pass size (MB): 94.67
Params size (MB): 90.44
Estimated Total Size (MB): 185.31
==========================================================================================
```

我们重点关注特征提取部分，可以看到网络在经过特征提取和融合后的输出形状为`[1, 256, 16, 16]`，这是我们修改代码的关键，另外两条新增分支的最终形状也要如此。