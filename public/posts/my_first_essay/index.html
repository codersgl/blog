<!DOCTYPE html>
<html lang="zh-Hans" dir="ltr">
    <head><script src="/blog/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=blog/livereload" data-no-instant defer></script><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="å‰æƒ…æè¦ å¯¼å¸ˆè®©æˆ‘å‘ä¸€ç¯‡æœŸåˆŠï¼Œå‚è€ƒè®ºæ–‡å’Œä»£ç éƒ½æœ‰ï¼Œè®©æˆ‘æ”¹ã€‚æ—¶é—´æ‰€å‰©ä¸å¤šå¤§æ¦‚ä¸¤ä¸ªç¤¼æ‹œã€‚ä¸ç®¡æ€æ ·ï¼Œå…ˆæ‹†è§£ä¸€ä¸‹ä»»åŠ¡ã€‚\næ”¹ä»£ç  è·‘ä»£ç  å†™è®ºæ–‡ æ”¹ä»£ç  ä¸»è¦çš„ä¿®æ”¹æ€è·¯æ˜¯ä¿®æ”¹ç‰¹å¾æå–éƒ¨åˆ†ï¼Œè®©æ¨¡å‹æå–æ›´å¤šçš„è¯­ä¹‰ä¿¡æ¯ä»¥æœŸæé«˜æ¨¡å‹çš„æ•´ä½“æ€§èƒ½ã€‚å…·ä½“æ¥è¯´æ˜¯åœ¨åŸç‰¹å¾æå–åˆ†æ”¯çš„åŸºç¡€ä¸Šæ·»åŠ ä¸¤ä¸ªç‰¹å¾æå–åˆ†æ”¯SAW2å’ŒDinov2ã€‚å¬èµ·æ¥æŒºç®€å•çš„ï¼Œä½†å…·ä½“æ“ä½œè¿˜æ˜¯ä¸å®¹æ˜“ã€‚å…ˆåˆ†æåŸå§‹ç‰¹å¾æå–åˆ†æ”¯çš„è¾“å…¥è¾“å‡ºå§ã€‚\n">
<title>codersgl&#39;s blog</title>

<link rel='canonical' href='http://localhost:1313/blog/posts/my_first_essay/'>

<link rel="stylesheet" href="/blog/scss/style.min.833d6eed45de56f48306bf57268d5b8cdfc8a60e8e7bdc99810464fcd033f7c6.css"><meta property='og:title' content="codersgl's blog">
<meta property='og:description' content="å‰æƒ…æè¦ å¯¼å¸ˆè®©æˆ‘å‘ä¸€ç¯‡æœŸåˆŠï¼Œå‚è€ƒè®ºæ–‡å’Œä»£ç éƒ½æœ‰ï¼Œè®©æˆ‘æ”¹ã€‚æ—¶é—´æ‰€å‰©ä¸å¤šå¤§æ¦‚ä¸¤ä¸ªç¤¼æ‹œã€‚ä¸ç®¡æ€æ ·ï¼Œå…ˆæ‹†è§£ä¸€ä¸‹ä»»åŠ¡ã€‚\næ”¹ä»£ç  è·‘ä»£ç  å†™è®ºæ–‡ æ”¹ä»£ç  ä¸»è¦çš„ä¿®æ”¹æ€è·¯æ˜¯ä¿®æ”¹ç‰¹å¾æå–éƒ¨åˆ†ï¼Œè®©æ¨¡å‹æå–æ›´å¤šçš„è¯­ä¹‰ä¿¡æ¯ä»¥æœŸæé«˜æ¨¡å‹çš„æ•´ä½“æ€§èƒ½ã€‚å…·ä½“æ¥è¯´æ˜¯åœ¨åŸç‰¹å¾æå–åˆ†æ”¯çš„åŸºç¡€ä¸Šæ·»åŠ ä¸¤ä¸ªç‰¹å¾æå–åˆ†æ”¯SAW2å’ŒDinov2ã€‚å¬èµ·æ¥æŒºç®€å•çš„ï¼Œä½†å…·ä½“æ“ä½œè¿˜æ˜¯ä¸å®¹æ˜“ã€‚å…ˆåˆ†æåŸå§‹ç‰¹å¾æå–åˆ†æ”¯çš„è¾“å…¥è¾“å‡ºå§ã€‚\n">
<meta property='og:url' content='http://localhost:1313/blog/posts/my_first_essay/'>
<meta property='og:site_name' content='codersgl&#39;s blog'>
<meta property='og:type' content='article'><meta property='article:section' content='Posts' /><meta property='article:published_time' content='2026-01-06T18:55:14&#43;08:00'/><meta property='article:modified_time' content='2026-01-06T18:55:14&#43;08:00'/><meta property='og:image' content='http://localhost:1313/blog/posts/my_first_essay/cover.jpeg' />
<meta name="twitter:title" content="codersgl's blog">
<meta name="twitter:description" content="å‰æƒ…æè¦ å¯¼å¸ˆè®©æˆ‘å‘ä¸€ç¯‡æœŸåˆŠï¼Œå‚è€ƒè®ºæ–‡å’Œä»£ç éƒ½æœ‰ï¼Œè®©æˆ‘æ”¹ã€‚æ—¶é—´æ‰€å‰©ä¸å¤šå¤§æ¦‚ä¸¤ä¸ªç¤¼æ‹œã€‚ä¸ç®¡æ€æ ·ï¼Œå…ˆæ‹†è§£ä¸€ä¸‹ä»»åŠ¡ã€‚\næ”¹ä»£ç  è·‘ä»£ç  å†™è®ºæ–‡ æ”¹ä»£ç  ä¸»è¦çš„ä¿®æ”¹æ€è·¯æ˜¯ä¿®æ”¹ç‰¹å¾æå–éƒ¨åˆ†ï¼Œè®©æ¨¡å‹æå–æ›´å¤šçš„è¯­ä¹‰ä¿¡æ¯ä»¥æœŸæé«˜æ¨¡å‹çš„æ•´ä½“æ€§èƒ½ã€‚å…·ä½“æ¥è¯´æ˜¯åœ¨åŸç‰¹å¾æå–åˆ†æ”¯çš„åŸºç¡€ä¸Šæ·»åŠ ä¸¤ä¸ªç‰¹å¾æå–åˆ†æ”¯SAW2å’ŒDinov2ã€‚å¬èµ·æ¥æŒºç®€å•çš„ï¼Œä½†å…·ä½“æ“ä½œè¿˜æ˜¯ä¸å®¹æ˜“ã€‚å…ˆåˆ†æåŸå§‹ç‰¹å¾æå–åˆ†æ”¯çš„è¾“å…¥è¾“å‡ºå§ã€‚\n"><meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content='http://localhost:1313/blog/posts/my_first_essay/cover.jpeg' />
    <link rel="shortcut icon" href="/blog/favicon.ico" />
<link rel="stylesheet" href="/blog/fonts/LXGW/lxgw.css" />
<style>
    @font-face {
        font-family: 'MapleMonoNF';
        src: url(/blog/fonts/MapleMono-NF-Regular.ttf);
    }

    :root {
        --sys-font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Droid Sans', 'Helvetica Neue';
        --zh-font-family: 'LXGW WenKai', 'PingFang SC', 'Hiragino Sans GB', 'Droid Sans Fallback', 'Microsoft YaHei';
        --base-font-family: 'LXGW WenKai', 'Lato', var(--sys-font-family), var(--zh-font-family), sans-serif;
        --code-font-family: MapleMonoNF, 'LXGW WenKai', Menlo, Monaco, Consolas, 'Courier New', var(--zh-font-family),
            monospace;
    }

     
    .highlight {
        font-size: 0.9em;
    }

     
    .caption {
        color: gray;
        font-size: 0.8em;
    }

    .article-content .gallery {
        margin: 0;
        width: 100%;
    }

     
    .menu-social li {
        margin-right: 0.4em;
    }

     
    .has-image .article-details:not(:has(.article-time)) {
        background: unset !important;
        background-color: rgba(0, 0, 0, 0.3) !important;
    }

     
    .has-image:has(.article-header) {
        border: 1px solid gray;
    }

    .article-subtitle {
        font-size: 1em;
        margin-top: 1em;
    }

     
    .related-content article .article-title {
        font-size: 1em;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .article-page .main-article .article-header .article-details {
        padding-bottom: 25px;
    }
</style>
<script>
    class FriendlyLink extends HTMLElement {
        connectedCallback() {
            const shadow = this.attachShadow({mode: 'open'});

            const src = this.getAttribute('src') || undefined;
            const title = this.getAttribute('title') || undefined;
            const description = this.getAttribute('desc') || undefined;

            shadow.innerHTML = `<style>
                .friend-link-card {
                    background-color: var(--card-bg-color);
                    border-radius: 8px;
                    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                    transition:
                        transform 0.2s ease,
                        box-shadow 0.2s ease;
                    overflow: hidden;
                }

                .friend-link-card:hover {
                    transform: translateY(-5px);
                    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
                }

                .friend-link-card a {
                    text-decoration: none;
                    color: inherit;
                    display: block;
                    padding: 15px;
                }

                .friend-link-info {
                    padding: 10px 0;
                }

                .friend-link-name {
                    margin: 0;
                    font-size: 1.2em;
                    color: var(--card-title-color);
                }

                .friend-link-description {
                    margin: 5px 0 0;
                    font-size: 0.9em;
                    color: var(--card-text-color);
                }
            </style>
            <div class="friend-link-card">
                <a href="${src}" target="_blank" rel="noopener noreferrer">
                    <div class="friend-link-info">
                    <h3 class="friend-link-name">${title}</h3>
                    <p class="friend-link-description">${description}</p>
                    </div>
                </a>
            </div>`;
        }
    }

    customElements.define('friendly-link', FriendlyLink);

</script>

    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "light");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="åˆ‡æ¢èœå•">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/blog/">
                
                    
                    
                    
                        
                        <img src="/blog/images/avatar_hu_966116bbcfed5fa1.jpg" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">ğŸ¥</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/blog">codersgl&#39;s blog</a></h1>
            <h2 class="site-description">Imagination is the source of all motivation.</h2>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='https://github.com/codersgl'
                        target="_blank"
                        title="GitHub ä¸»é¡µ"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='/blog/index.xml'
                        
                        title="RSS è®¢é˜…"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-rss" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="5" cy="19" r="1" />
  <path d="M4 4a16 16 0 0 1 16 16" />
  <path d="M4 11a9 9 0 0 1 9 9" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/blog/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>é¦–é¡µ</span>
            </a>
        </li>
        
        
        <li >
            <a href='/blog/page/archives' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>å½’æ¡£</span>
            </a>
        </li>
        
        
        <li >
            <a href='/blog/page/links' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>å‹é“¾</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>æš—è‰²æ¨¡å¼</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                <form action="/blog/page/search/" class="search-form widget" >
        <p>
            <label>æœç´¢</label>
            <input name="keyword" required autocomplete="off" placeholder="è¾“å…¥å…³é”®è¯..." />
        
            <button title="æœç´¢">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



            </button>
        </p>
    </form>
            
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">ç›®å½•</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ul>
    <li><a href="#å‰æƒ…æè¦">å‰æƒ…æè¦</a></li>
    <li><a href="#æ”¹ä»£ç ">æ”¹ä»£ç </a>
      <ul>
        <li><a href="#input">input</a></li>
        <li><a href="#net-info">Net info</a>
          <ul>
            <li><a href="#dsgc-net">DSGC-Net</a></li>
            <li><a href="#dsu-net">DSU-Net</a></li>
          </ul>
        </li>
        <li><a href="#å¼€å§‹ä¿®æ”¹">å¼€å§‹ä¿®æ”¹</a></li>
      </ul>
    </li>
    <li><a href="#è·‘ä»£ç ">è·‘ä»£ç </a></li>
    <li><a href="#å†™è®ºæ–‡">å†™è®ºæ–‡</a></li>
    <li><a href="#å‚è€ƒè®ºæ–‡">å‚è€ƒè®ºæ–‡</a></li>
  </ul>
</nav>
        </div>
    </section>

            
        
            
                <section class="widget tagCloud">
    <div class="widget-icon">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



    </div>
    <h2 class="widget-title section-title">åˆ†ç±»</h2>

    <div class="tagCloud-tags">
        
            <a href="/blog/categories/jotting/" class="font_size_1">
                Jotting
            </a>
        
            <a href="/blog/categories/tools/" class="font_size_1">
                Tools
            </a>
        
    </div>
</section>

            
        
            
                <section class="widget tagCloud">
    <div class="widget-icon">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-tag" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11 3L20 12a1.5 1.5 0 0 1 0 2L14 20a1.5 1.5 0 0 1 -2 0L3 11v-4a4 4 0 0 1 4 -4h4" />
  <circle cx="9" cy="9" r="2" />
</svg>



    </div>
    <h2 class="widget-title section-title">æ ‡ç­¾äº‘</h2>

    <div class="tagCloud-tags">
        
            <a href="/blog/tags/c/c&#43;&#43;/">
                C/C&#43;&#43;
            </a>
        
            <a href="/blog/tags/neovim/">
                Neovim
            </a>
        
    </div>
</section>

            
        
    </aside>


            <main class="main full-width">
    <article class="has-image main-article">
    <header class="article-header">
        <div class="article-image">
            <a href="/blog/posts/my_first_essay/">
                <img src="/blog/posts/my_first_essay/cover.jpeg"
                        
                        width="1792" 
                        height="1024" 
                        loading="lazy"
                        alt="Featured image of post My_first_essay" />
                
            </a>
        </div>
    

    <div class="article-details">
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/blog/posts/my_first_essay/">My_first_essay</a>
        </h2>
    
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published" datetime='2026-01-06T18:55:14&#43;08:00'>Jan 06, 2026</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    é˜…è¯»æ—¶é•¿: 27 åˆ†é’Ÿ
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <h2 id="å‰æƒ…æè¦">å‰æƒ…æè¦
</h2><p>å¯¼å¸ˆè®©æˆ‘å‘ä¸€ç¯‡æœŸåˆŠï¼Œå‚è€ƒè®ºæ–‡å’Œä»£ç éƒ½æœ‰ï¼Œè®©æˆ‘æ”¹ã€‚æ—¶é—´æ‰€å‰©ä¸å¤šå¤§æ¦‚ä¸¤ä¸ªç¤¼æ‹œã€‚ä¸ç®¡æ€æ ·ï¼Œå…ˆæ‹†è§£ä¸€ä¸‹ä»»åŠ¡ã€‚</p>
<ul>
<li><input disabled="" type="checkbox"> æ”¹ä»£ç </li>
<li><input disabled="" type="checkbox"> è·‘ä»£ç </li>
<li><input disabled="" type="checkbox"> å†™è®ºæ–‡</li>
</ul>
<h2 id="æ”¹ä»£ç ">æ”¹ä»£ç 
</h2><p>ä¸»è¦çš„ä¿®æ”¹æ€è·¯æ˜¯ä¿®æ”¹ç‰¹å¾æå–éƒ¨åˆ†ï¼Œè®©æ¨¡å‹æå–æ›´å¤šçš„è¯­ä¹‰ä¿¡æ¯ä»¥æœŸæé«˜æ¨¡å‹çš„æ•´ä½“æ€§èƒ½ã€‚å…·ä½“æ¥è¯´æ˜¯åœ¨åŸç‰¹å¾æå–åˆ†æ”¯çš„åŸºç¡€ä¸Šæ·»åŠ ä¸¤ä¸ªç‰¹å¾æå–åˆ†æ”¯SAW2å’ŒDinov2ã€‚å¬èµ·æ¥æŒºç®€å•çš„ï¼Œä½†å…·ä½“æ“ä½œè¿˜æ˜¯ä¸å®¹æ˜“ã€‚å…ˆåˆ†æåŸå§‹ç‰¹å¾æå–åˆ†æ”¯çš„è¾“å…¥è¾“å‡ºå§ã€‚</p>
<h3 id="input">input
</h3><p>ç½‘ç»œçš„è¾“å…¥å¯ä»¥ä»æ•°æ®åŠ è½½ (loading_data.py, SHHA.py) å’Œå¤„ç†æµç¨‹ (engine.py, collate_fn) ä¸­æ¨æ–­å‡ºæ¥ã€‚</p>
<p>ç®€è€Œè¨€ä¹‹ï¼ŒDSGCNet ç½‘ç»œçš„è¾“å…¥æ˜¯ä¸€ä¸ªæ ‡å‡†çš„ 4D PyTorch å¼ é‡ï¼ŒåŒ…å«äº†ä¸€æ‰¹ç»è¿‡é¢„å¤„ç†å’Œå½’ä¸€åŒ–çš„ RGB å›¾åƒã€‚</p>
<p>å…·ä½“è¾“å…¥æ ¼å¼</p>
<ol>
<li>è®­ç»ƒé˜¶æ®µ (Training)
åœ¨è®­ç»ƒæ—¶ï¼Œç½‘ç»œæ¥æ”¶çš„è¾“å…¥å¼ é‡å½¢çŠ¶é€šå¸¸ä¸ºï¼š</li>
</ol>
<p>$$(B \times 4, 3, 128, 128)$$</p>
<ul>
<li>B (Batch Size): ç”± train.py ä¸­çš„ &ndash;batch_size å‚æ•°æ§åˆ¶ï¼ˆé»˜è®¤ 8ï¼‰ã€‚</li>
<li>4 (Num Patches): æ•°æ®åŠ è½½é€šè¿‡ random_crop å°†æ¯å¼ åŸå§‹å›¾åƒè£å‰ªä¸º 4 ä¸ª patchesã€‚collate_fn_crowd_train ä¼šå°†è¿™ 4 ä¸ª patch å±•å¹³å¹¶å…¥ Batch ç»´åº¦ã€‚</li>
<li>3 (Channels): RGB é€šé“ã€‚</li>
<li>128Ã—128 (Resolution): è®­ç»ƒæ—¶ä½¿ç”¨å›ºå®šå¤§å°çš„éšæœºè£å‰ªï¼ˆåœ¨ SHHA.py ä¸­ç¡¬ç¼–ç ä¸º 128ï¼‰ã€‚</li>
</ul>
<blockquote>
<p>éšæœºè£å‰ªçš„ç›®çš„ï¼šä»ä¸€å¼ å¤§å›¾ä¸­éšæœºè£å‰ª 4 ä¸ªä¸åŒçš„åŒºåŸŸï¼Œç›¸å½“äºå¢åŠ äº†è®­ç»ƒæ•°æ®çš„å¤šæ ·æ€§ã€‚è¿™æœ‰åŠ©äºæ¨¡å‹å­¦ä¹ å±€éƒ¨ç‰¹å¾ï¼Œé˜²æ­¢è¿‡æ‹Ÿåˆï¼Œå¹¶æé«˜æ¨¡å‹å¯¹ä¸åŒå¯†åº¦åˆ†å¸ƒåŒºåŸŸçš„é²æ£’æ€§ã€‚</p>
</blockquote>
<p>æ•°æ®ç±»å‹: Float32ã€‚å½’ä¸€åŒ–: ä½¿ç”¨ ImageNet æ ‡å‡†å‡å€¼å’Œæ–¹å·®ï¼š
Mean: [0.485, 0.456, 0.406]
Std: [0.229, 0.224, 0.225]</p>
<ol start="2">
<li>æµ‹è¯•/è¯„ä¼°é˜¶æ®µ (Evaluation)
åœ¨è¯„ä¼°æ—¶ï¼Œé€šå¸¸ batch_size è®¾ä¸º 1ï¼ˆå› ä¸ºå›¾åƒåˆ†è¾¨ç‡ä¸ä¸€ï¼‰ï¼Œè¾“å…¥å½¢çŠ¶ä¸ºï¼š</li>
</ol>
<p>$$(1, 3, H, W)$$</p>
<ul>
<li>H,W: åŸå§‹å›¾åƒçš„é«˜åº¦å’Œå®½åº¦ï¼ˆä¸ºäº†å¤„ç†ä¸åŒå°ºå¯¸ï¼Œé€šå¸¸ä½¿ç”¨ Padding æˆ– Batch Size=1ï¼‰ã€‚</li>
</ul>
<blockquote>
<p>æ³¨æ„: è¿™é‡Œçš„ H å’Œ W ä¼šè¢«å¤„ç†æˆ 128 çš„å€æ•°ï¼ˆé€šè¿‡ paddingï¼‰ï¼Œè¿™åœ¨ misc.py çš„ nested_tensor_from_tensor_list ä¸­å¤„ç†ã€‚</p>
</blockquote>
<p>è¾…åŠ©è¾“å…¥ (ç”¨äº Loss è®¡ç®—)
è™½ç„¶ç½‘ç»œå‰å‘ä¼ æ’­ (model(samples)) åªæ¥æ”¶å›¾åƒå¼ é‡ï¼Œä½†åœ¨è®­ç»ƒå¾ªç¯ (engine.py) ä¸­ï¼Œè¿˜éœ€è¦ä»¥ä¸‹æ•°æ®æ¥è®¡ç®—æŸå¤±ï¼š</p>
<ul>
<li>Ground Truth Density Map (gt_dmap): å½¢çŠ¶å¯¹åº”äºè¾“å…¥å›¾åƒï¼Œç”¨äºç›‘ç£ Density Approximation åˆ†æ”¯ã€‚</li>
<li>Point Annotations (targets): åŒ…å«äººå‘˜åæ ‡ç‚¹
(point)ï¼Œç”¨äºç›‘ç£ Representation Approximation åˆ†æ”¯å’Œåˆ†ç±»/å›å½’æŸå¤±ã€‚</li>
</ul>
<h3 id="net-info">Net info
</h3><h4 id="dsgc-net">DSGC-Net
</h4><p><img src="/blog/posts/my_first_essay/DSGCNet_architecture.png"
	width="1119"
	height="535"
	
	loading="lazy"
	
		alt="DSGCNet_architecture"
	
	
		class="gallery-image" 
		data-flex-grow="209"
		data-flex-basis="501px"
	
></p>
<p>è¿™æ˜¯DSGC-Netçš„ç½‘ç»œå®šä¹‰</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">DSGCnet</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">backbone</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">backbone</span> <span class="o">=</span> <span class="n">backbone</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">num_classes</span> <span class="o">=</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">        <span class="n">num_anchor_points</span> <span class="o">=</span> <span class="n">row</span> <span class="o">*</span> <span class="n">line</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">fusion_total</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">256</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">regression</span> <span class="o">=</span> <span class="n">RegressionModel</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">num_features_in</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="n">num_anchor_points</span><span class="o">=</span><span class="n">num_anchor_points</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">classification</span> <span class="o">=</span> <span class="n">ClassificationModel</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">num_features_in</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">num_classes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_classes</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">num_anchor_points</span><span class="o">=</span><span class="n">num_anchor_points</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">anchor_points</span> <span class="o">=</span> <span class="n">AnchorPoints</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">pyramid_levels</span><span class="o">=</span><span class="p">[</span>
</span></span><span class="line"><span class="cl">                <span class="mi">3</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="n">row</span><span class="o">=</span><span class="n">row</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">line</span><span class="o">=</span><span class="n">line</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">pa</span> <span class="o">=</span> <span class="n">Decoder_SPD_PAFPN</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">512</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">density_pred</span> <span class="o">=</span> <span class="n">Density_pred</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">density_gcn</span> <span class="o">=</span> <span class="n">DensityGCNProcessor</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">feature_gcn</span> <span class="o">=</span> <span class="n">FeatureGCNProcessor</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">samples</span><span class="p">:</span> <span class="n">NestedTensor</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backbone</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">features_pa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pa</span><span class="p">([</span><span class="n">features</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">features</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">features</span><span class="p">[</span><span class="mi">3</span><span class="p">]])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">density</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_pred</span><span class="p">(</span><span class="n">features_pa</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">density_gcn_feature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_gcn</span><span class="p">(</span><span class="n">density</span><span class="p">,</span> <span class="n">features_pa</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">feature_gcn_feature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_gcn</span><span class="p">(</span><span class="n">features_pa</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">feature_fl</span> <span class="o">=</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">features_pa</span>
</span></span><span class="line"><span class="cl">            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">density_gcn_feature</span>
</span></span><span class="line"><span class="cl">            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">feature_gcn_feature</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">regression</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">regression</span><span class="p">(</span><span class="n">feature_fl</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
</span></span><span class="line"><span class="cl">        <span class="n">classification</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classification</span><span class="p">(</span><span class="n">feature_fl</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">anchor_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">anchor_points</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">output_coord</span> <span class="o">=</span> <span class="n">regression</span> <span class="o">+</span> <span class="n">anchor_points</span>
</span></span><span class="line"><span class="cl">        <span class="n">output_class</span> <span class="o">=</span> <span class="n">classification</span>
</span></span><span class="line"><span class="cl">        <span class="n">out</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;pred_logits&#34;</span><span class="p">:</span> <span class="n">output_class</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;pred_points&#34;</span><span class="p">:</span> <span class="n">output_coord</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;density_out&#34;</span><span class="p">:</span> <span class="n">density</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">out</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿è¡Œä¸‹é¢çš„è„šæœ¬ï¼ŒæŸ¥çœ‹è¾“å…¥æ•°æ®åœ¨ç½‘ç»œä¸­çš„æµåŠ¨æƒ…å†µ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">torch</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">torchinfo</span> <span class="kn">import</span> <span class="n">summary</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">models.DSGCnet</span> <span class="kn">import</span> <span class="n">DSGCnet</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">models.backbone</span> <span class="kn">import</span> <span class="n">Backbone_VGG</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">device</span> <span class="o">=</span> <span class="s2">&#34;cuda&#34;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&#34;cpu&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">input</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">backbone</span> <span class="o">=</span> <span class="n">Backbone_VGG</span><span class="p">(</span><span class="s2">&#34;vgg16_bn&#34;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">dsgc_net</span> <span class="o">=</span> <span class="n">DSGCnet</span><span class="p">(</span><span class="n">backbone</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">summary</span><span class="p">(</span><span class="n">dsgc_net</span><span class="p">,</span> <span class="n">input_data</span><span class="o">=</span><span class="nb">input</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¾“å‡ºå¦‚ä¸‹:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">==========================================================================================
</span></span><span class="line"><span class="cl">Layer (type:depth-idx)                   Output Shape              Param #
</span></span><span class="line"><span class="cl">==========================================================================================
</span></span><span class="line"><span class="cl">DSGCnet                                  [1, 1, 16, 16]            197,378
</span></span><span class="line"><span class="cl">â”œâ”€Backbone_VGG: 1-1                      [1, 128, 64, 64]          --
</span></span><span class="line"><span class="cl">â”‚    â””â”€Sequential: 2-1                   [1, 128, 64, 64]          --
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€Conv2d: 3-1                  [1, 64, 128, 128]         1,792
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BatchNorm2d: 3-2             [1, 64, 128, 128]         128
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€ReLU: 3-3                    [1, 64, 128, 128]         --
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€Conv2d: 3-4                  [1, 64, 128, 128]         36,928
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BatchNorm2d: 3-5             [1, 64, 128, 128]         128
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€ReLU: 3-6                    [1, 64, 128, 128]         --
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€MaxPool2d: 3-7               [1, 64, 64, 64]           --
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€Conv2d: 3-8                  [1, 128, 64, 64]          73,856
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BatchNorm2d: 3-9             [1, 128, 64, 64]          256
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€ReLU: 3-10                   [1, 128, 64, 64]          --
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€Conv2d: 3-11                 [1, 128, 64, 64]          147,584
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BatchNorm2d: 3-12            [1, 128, 64, 64]          256
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€ReLU: 3-13                   [1, 128, 64, 64]          --
</span></span><span class="line"><span class="cl">â”‚    â””â”€Sequential: 2-2                   [1, 256, 32, 32]          --
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€MaxPool2d: 3-14              [1, 128, 32, 32]          --
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€Conv2d: 3-15                 [1, 256, 32, 32]          295,168
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BatchNorm2d: 3-16            [1, 256, 32, 32]          512
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€ReLU: 3-17                   [1, 256, 32, 32]          --
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€Conv2d: 3-18                 [1, 256, 32, 32]          590,080
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BatchNorm2d: 3-19            [1, 256, 32, 32]          512
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€ReLU: 3-20                   [1, 256, 32, 32]          --
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€Conv2d: 3-21                 [1, 256, 32, 32]          590,080
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BatchNorm2d: 3-22            [1, 256, 32, 32]          512
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€ReLU: 3-23                   [1, 256, 32, 32]          --
</span></span><span class="line"><span class="cl">â”‚    â””â”€Sequential: 2-3                   [1, 512, 16, 16]          --
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€MaxPool2d: 3-24              [1, 256, 16, 16]          --
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€Conv2d: 3-25                 [1, 512, 16, 16]          1,180,160
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BatchNorm2d: 3-26            [1, 512, 16, 16]          1,024
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€ReLU: 3-27                   [1, 512, 16, 16]          --
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€Conv2d: 3-28                 [1, 512, 16, 16]          2,359,808
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BatchNorm2d: 3-29            [1, 512, 16, 16]          1,024
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€ReLU: 3-30                   [1, 512, 16, 16]          --
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€Conv2d: 3-31                 [1, 512, 16, 16]          2,359,808
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BatchNorm2d: 3-32            [1, 512, 16, 16]          1,024
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€ReLU: 3-33                   [1, 512, 16, 16]          --
</span></span><span class="line"><span class="cl">â”‚    â””â”€Sequential: 2-4                   [1, 512, 8, 8]            --
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€MaxPool2d: 3-34              [1, 512, 8, 8]            --
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€Conv2d: 3-35                 [1, 512, 8, 8]            2,359,808
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BatchNorm2d: 3-36            [1, 512, 8, 8]            1,024
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€ReLU: 3-37                   [1, 512, 8, 8]            --
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€Conv2d: 3-38                 [1, 512, 8, 8]            2,359,808
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BatchNorm2d: 3-39            [1, 512, 8, 8]            1,024
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€ReLU: 3-40                   [1, 512, 8, 8]            --
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€Conv2d: 3-41                 [1, 512, 8, 8]            2,359,808
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BatchNorm2d: 3-42            [1, 512, 8, 8]            1,024
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€ReLU: 3-43                   [1, 512, 8, 8]            --
</span></span><span class="line"><span class="cl">â”œâ”€Decoder_SPD_PAFPN: 1-2                 [1, 256, 16, 16]          --
</span></span><span class="line"><span class="cl">â”‚    â””â”€Sequential: 2-5                   [1, 256, 8, 8]            --
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€Conv2d: 3-44                 [1, 256, 8, 8]            131,328
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BatchNorm2d: 3-45            [1, 256, 8, 8]            512
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€ReLU: 3-46                   [1, 256, 8, 8]            --
</span></span><span class="line"><span class="cl">â”‚    â””â”€Upsample: 2-6                     [1, 256, 16, 16]          --
</span></span><span class="line"><span class="cl">â”‚    â””â”€Sequential: 2-7                   [1, 256, 8, 8]            --
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€Conv2d: 3-47                 [1, 256, 8, 8]            590,080
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BatchNorm2d: 3-48            [1, 256, 8, 8]            512
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€ReLU: 3-49                   [1, 256, 8, 8]            --
</span></span><span class="line"><span class="cl">â”‚    â””â”€Sequential: 2-8                   [1, 256, 16, 16]          --
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€Conv2d: 3-50                 [1, 256, 16, 16]          131,328
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BatchNorm2d: 3-51            [1, 256, 16, 16]          512
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€ReLU: 3-52                   [1, 256, 16, 16]          --
</span></span><span class="line"><span class="cl">â”‚    â””â”€Upsample: 2-9                     [1, 256, 32, 32]          --
</span></span><span class="line"><span class="cl">â”‚    â””â”€Sequential: 2-10                  [1, 256, 16, 16]          --
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€Conv2d: 3-53                 [1, 256, 16, 16]          590,080
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BatchNorm2d: 3-54            [1, 256, 16, 16]          512
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€ReLU: 3-55                   [1, 256, 16, 16]          --
</span></span><span class="line"><span class="cl">â”‚    â””â”€Sequential: 2-11                  [1, 256, 32, 32]          --
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€Conv2d: 3-56                 [1, 256, 32, 32]          65,792
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BatchNorm2d: 3-57            [1, 256, 32, 32]          512
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€ReLU: 3-58                   [1, 256, 32, 32]          --
</span></span><span class="line"><span class="cl">â”‚    â””â”€Sequential: 2-12                  [1, 256, 32, 32]          --
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€Conv2d: 3-59                 [1, 256, 32, 32]          590,080
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BatchNorm2d: 3-60            [1, 256, 32, 32]          512
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€ReLU: 3-61                   [1, 256, 32, 32]          --
</span></span><span class="line"><span class="cl">â”‚    â””â”€Sequential: 2-13                  [1, 256, 16, 16]          --
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€SPD: 3-62                    [1, 1024, 16, 16]         --
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€Conv2d: 3-63                 [1, 256, 16, 16]          262,400
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BatchNorm2d: 3-64            [1, 256, 16, 16]          512
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€ReLU: 3-65                   [1, 256, 16, 16]          --
</span></span><span class="line"><span class="cl">â”‚    â””â”€Sequential: 2-14                  [1, 256, 16, 16]          (recursive)
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€Conv2d: 3-66                 [1, 256, 16, 16]          (recursive)
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BatchNorm2d: 3-67            [1, 256, 16, 16]          (recursive)
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€ReLU: 3-68                   [1, 256, 16, 16]          --
</span></span><span class="line"><span class="cl">â”‚    â””â”€Sequential: 2-15                  [1, 256, 8, 8]            --
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€SPD: 3-69                    [1, 1024, 8, 8]           --
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€Conv2d: 3-70                 [1, 256, 8, 8]            262,400
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BatchNorm2d: 3-71            [1, 256, 8, 8]            512
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€ReLU: 3-72                   [1, 256, 8, 8]            --
</span></span><span class="line"><span class="cl">â”‚    â””â”€Sequential: 2-16                  [1, 256, 8, 8]            (recursive)
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€Conv2d: 3-73                 [1, 256, 8, 8]            (recursive)
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BatchNorm2d: 3-74            [1, 256, 8, 8]            (recursive)
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€ReLU: 3-75                   [1, 256, 8, 8]            --
</span></span><span class="line"><span class="cl">â”‚    â””â”€Upsample: 2-17                    [1, 256, 16, 16]          --
</span></span><span class="line"><span class="cl">â”‚    â””â”€Sequential: 2-18                  [1, 256, 16, 16]          --
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€Conv2d: 3-76                 [1, 256, 16, 16]          196,864
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BatchNorm2d: 3-77            [1, 256, 16, 16]          512
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€ReLU: 3-78                   [1, 256, 16, 16]          --
</span></span><span class="line"><span class="cl">â”œâ”€Density_pred: 1-3                      [1, 1, 16, 16]            --
</span></span><span class="line"><span class="cl">â”‚    â””â”€Sequential: 2-19                  [1, 256, 16, 16]          --
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€Conv2d: 3-79                 [1, 256, 16, 16]          590,080
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BatchNorm2d: 3-80            [1, 256, 16, 16]          512
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€ReLU: 3-81                   [1, 256, 16, 16]          --
</span></span><span class="line"><span class="cl">â”‚    â””â”€Sequential: 2-20                  [1, 256, 16, 16]          --
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€Conv2d: 3-82                 [1, 256, 16, 16]          590,080
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BatchNorm2d: 3-83            [1, 256, 16, 16]          512
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€ReLU: 3-84                   [1, 256, 16, 16]          --
</span></span><span class="line"><span class="cl">â”‚    â””â”€Sequential: 2-21                  [1, 256, 16, 16]          --
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€Conv2d: 3-85                 [1, 256, 16, 16]          590,080
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BatchNorm2d: 3-86            [1, 256, 16, 16]          512
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€ReLU: 3-87                   [1, 256, 16, 16]          --
</span></span><span class="line"><span class="cl">â”‚    â””â”€Sequential: 2-22                  [1, 1, 16, 16]            --
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€Conv2d: 3-88                 [1, 128, 16, 16]          295,040
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BatchNorm2d: 3-89            [1, 128, 16, 16]          256
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€ReLU: 3-90                   [1, 128, 16, 16]          --
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€Conv2d: 3-91                 [1, 64, 16, 16]           73,792
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BatchNorm2d: 3-92            [1, 64, 16, 16]           128
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€ReLU: 3-93                   [1, 64, 16, 16]           --
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€Conv2d: 3-94                 [1, 1, 16, 16]            65
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€ReLU: 3-95                   [1, 1, 16, 16]            --
</span></span><span class="line"><span class="cl">â”œâ”€DensityGCNProcessor: 1-4               [1, 256, 16, 16]          --
</span></span><span class="line"><span class="cl">â”‚    â””â”€GCNModel: 2-23                    [256, 256]                --
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€GCNConv: 3-96                [256, 512]                131,584
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€GCNConv: 3-97                [256, 256]                131,328
</span></span><span class="line"><span class="cl">â”œâ”€FeatureGCNProcessor: 1-5               [1, 256, 16, 16]          --
</span></span><span class="line"><span class="cl">â”‚    â””â”€GCNModel: 2-24                    [256, 256]                --
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€GCNConv: 3-98                [256, 512]                131,584
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€GCNConv: 3-99                [256, 256]                131,328
</span></span><span class="line"><span class="cl">â”œâ”€RegressionModel: 1-6                   [1, 1024, 2]              1,180,160
</span></span><span class="line"><span class="cl">â”‚    â””â”€Conv2d: 2-25                      [1, 256, 16, 16]          590,080
</span></span><span class="line"><span class="cl">â”‚    â””â”€ReLU: 2-26                        [1, 256, 16, 16]          --
</span></span><span class="line"><span class="cl">â”‚    â””â”€Conv2d: 2-27                      [1, 256, 16, 16]          590,080
</span></span><span class="line"><span class="cl">â”‚    â””â”€ReLU: 2-28                        [1, 256, 16, 16]          --
</span></span><span class="line"><span class="cl">â”‚    â””â”€Conv2d: 2-29                      [1, 8, 16, 16]            18,440
</span></span><span class="line"><span class="cl">â”œâ”€ClassificationModel: 1-7               [1, 1024, 2]              1,180,160
</span></span><span class="line"><span class="cl">â”‚    â””â”€Conv2d: 2-30                      [1, 256, 16, 16]          590,080
</span></span><span class="line"><span class="cl">â”‚    â””â”€ReLU: 2-31                        [1, 256, 16, 16]          --
</span></span><span class="line"><span class="cl">â”‚    â””â”€Conv2d: 2-32                      [1, 256, 16, 16]          590,080
</span></span><span class="line"><span class="cl">â”‚    â””â”€ReLU: 2-33                        [1, 256, 16, 16]          --
</span></span><span class="line"><span class="cl">â”‚    â””â”€Conv2d: 2-34                      [1, 8, 16, 16]            18,440
</span></span><span class="line"><span class="cl">â”œâ”€AnchorPoints: 1-8                      [1, 1024, 2]              --
</span></span><span class="line"><span class="cl">==========================================================================================
</span></span><span class="line"><span class="cl">Total params: 25,169,875
</span></span><span class="line"><span class="cl">Trainable params: 25,169,875
</span></span><span class="line"><span class="cl">Non-trainable params: 0
</span></span><span class="line"><span class="cl">Total mult-adds (G): 7.54
</span></span><span class="line"><span class="cl">==========================================================================================
</span></span><span class="line"><span class="cl">Input size (MB): 0.20
</span></span><span class="line"><span class="cl">Forward/backward pass size (MB): 94.67
</span></span><span class="line"><span class="cl">Params size (MB): 90.44
</span></span><span class="line"><span class="cl">Estimated Total Size (MB): 185.31
</span></span><span class="line"><span class="cl">==========================================================================================
</span></span></code></pre></td></tr></table>
</div>
</div><p>æˆ‘ä»¬é‡ç‚¹å…³æ³¨ç‰¹å¾æå–éƒ¨åˆ†ï¼Œå¯ä»¥çœ‹åˆ°ç½‘ç»œåœ¨ç»è¿‡ç‰¹å¾æå–å’Œèåˆåçš„è¾“å‡ºå½¢çŠ¶ä¸º<code>[1, 256, 16, 16]</code>ï¼Œè¿™æ˜¯æˆ‘ä»¬ä¿®æ”¹ä»£ç çš„å…³é”®ï¼Œå¦å¤–ä¸¤æ¡æ–°å¢åˆ†æ”¯çš„æœ€ç»ˆå½¢çŠ¶ä¹Ÿè¦å¦‚æ­¤ã€‚</p>
<h4 id="dsu-net">DSU-Net
</h4><p>æ¥ä¸‹æ¥è§‚å¯Ÿä¸€ä¸‹<code>DSU-Net</code>çš„ç½‘ç»œç»“æ„å’Œè¾“å…¥è¾“å‡ºï¼š</p>
<p><img src="/blog/posts/my_first_essay/DSU-Net.png"
	width="870"
	height="416"
	
	loading="lazy"
	
		alt="DSU-Net Architecture"
	
	
		class="gallery-image" 
		data-flex-grow="209"
		data-flex-basis="501px"
	
></p>
<p>è¿™æ˜¯DGSU-Netçš„ç½‘ç»œå®šä¹‰ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">DGSUNet</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">dino_model_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">dino_hub_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">sam_config_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">sam_ckpt_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">super</span><span class="p">(</span><span class="n">DGSUNet</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">dino_model_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;No model_name specified, using default&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">dino_model_name</span> <span class="o">=</span> <span class="s2">&#34;dinov2_vitl14&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">dino_hub_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;No dino_hub_dir specified, using default&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">dino_hub_dir</span> <span class="o">=</span> <span class="s2">&#34;facebookresearch/dinov2&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">sam_config_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;No sam_config_file specified, using default&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Replace with your own SAM configuration file path</span>
</span></span><span class="line"><span class="cl">            <span class="n">sam_config_file</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&#34;../sam2_configs/sam2.1_hiera_l.yaml&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">sam_ckpt_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;No sam_ckpt_path specified, using default&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Replace with your own SAM pt file path</span>
</span></span><span class="line"><span class="cl">            <span class="n">sam_ckpt_path</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&#34;checkpoints/sam2.1_hiera_large.pt&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Backbone Feature Extractor</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">backbone_dino</span> <span class="o">=</span> <span class="n">dinov2_extract</span><span class="o">.</span><span class="n">DinoV2FeatureExtractor</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">dino_model_name</span><span class="p">,</span> <span class="n">dino_hub_dir</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">backbone_sam</span> <span class="o">=</span> <span class="n">sam2hiera</span><span class="o">.</span><span class="n">sam2hiera</span><span class="p">(</span><span class="n">sam_config_file</span><span class="p">,</span> <span class="n">sam_ckpt_path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Feature Fusion</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">fusion4</span> <span class="o">=</span> <span class="n">CGAFusion</span><span class="o">.</span><span class="n">CGAFusion</span><span class="p">(</span><span class="mi">1152</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># (1024,37,37)-&gt;(1024,11,11)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">dino2sam_down4</span> <span class="o">=</span> <span class="n">updown</span><span class="o">.</span><span class="n">interpolate_upsample</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># (1024,11,11)-&gt;(1152,11,11)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">dino2sam_down14</span> <span class="o">=</span> <span class="n">wtconv</span><span class="o">.</span><span class="n">DepthwiseSeparableConvWithWTConv2d</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">in_channels</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span> <span class="n">out_channels</span><span class="o">=</span><span class="mi">1152</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">rfb1</span> <span class="o">=</span> <span class="n">RFB</span><span class="o">.</span><span class="n">RFB_modified</span><span class="p">(</span><span class="mi">144</span><span class="p">,</span> <span class="mi">64</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">rfb2</span> <span class="o">=</span> <span class="n">RFB</span><span class="o">.</span><span class="n">RFB_modified</span><span class="p">(</span><span class="mi">288</span><span class="p">,</span> <span class="mi">64</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">rfb3</span> <span class="o">=</span> <span class="n">RFB</span><span class="o">.</span><span class="n">RFB_modified</span><span class="p">(</span><span class="mi">576</span><span class="p">,</span> <span class="mi">64</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">rfb4</span> <span class="o">=</span> <span class="n">RFB</span><span class="o">.</span><span class="n">RFB_modified</span><span class="p">(</span><span class="mi">1152</span><span class="p">,</span> <span class="mi">64</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">decoder1</span> <span class="o">=</span> <span class="n">sff</span><span class="o">.</span><span class="n">SFF</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">decoder2</span> <span class="o">=</span> <span class="n">sff</span><span class="o">.</span><span class="n">SFF</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">decoder3</span> <span class="o">=</span> <span class="n">sff</span><span class="o">.</span><span class="n">SFF</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">side1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">side2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">head</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_dino</span><span class="p">,</span> <span class="n">x_sam</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Backbone Feature Extractor</span>
</span></span><span class="line"><span class="cl">        <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">x3</span><span class="p">,</span> <span class="n">x4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backbone_sam</span><span class="p">(</span><span class="n">x_sam</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">x_dino</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backbone_dino</span><span class="p">(</span><span class="n">x_dino</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># change dino feature map size and dimension</span>
</span></span><span class="line"><span class="cl">        <span class="n">x_dino4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dino2sam_down4</span><span class="p">(</span><span class="n">x_dino</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">x_dino4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dino2sam_down14</span><span class="p">(</span><span class="n">x_dino4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Feature Fusion(sam &amp; dino)</span>
</span></span><span class="line"><span class="cl">        <span class="n">x4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fusion4</span><span class="p">(</span><span class="n">x4</span><span class="p">,</span> <span class="n">x_dino4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># change fusion feature map dimension-&gt;(64,11/22/44/88,11/22/44/88)</span>
</span></span><span class="line"><span class="cl">        <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">x3</span><span class="p">,</span> <span class="n">x4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rfb1</span><span class="p">(</span><span class="n">x1</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">rfb2</span><span class="p">(</span><span class="n">x2</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">rfb3</span><span class="p">(</span><span class="n">x3</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">rfb4</span><span class="p">(</span><span class="n">x4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder1</span><span class="p">(</span><span class="n">x4</span><span class="p">,</span> <span class="n">x3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">out1</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">side1</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">scale_factor</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&#34;bilinear&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">out2</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">side2</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">scale_factor</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&#34;bilinear&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder3</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">out3</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">scale_factor</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&#34;bilinear&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">out1</span><span class="p">,</span> <span class="n">out2</span><span class="p">,</span> <span class="n">out3</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ ¹æ® DGSUNet.py å’Œæµ‹è¯•è„šæœ¬ï¼Œè¾“å…¥å½¢çŠ¶è§„å®šå¦‚ä¸‹ï¼š</p>
<ol>
<li>
<p><strong><code>x_dino</code> (DiNOv2 è¾“å…¥)</strong>: <code>(B, 3, 518, 518)</code></p>
<ul>
<li>ä¸»è¦ç”¨äºè¯­ä¹‰ç‰¹å¾æå–ã€‚</li>
<li>åˆ†è¾¨ç‡å›ºå®šä¸º 518x518ã€‚</li>
</ul>
</li>
<li>
<p><strong><code>x_sam</code> (SAM2 è¾“å…¥)</strong>: <code>(B, 3, 352, 352)</code></p>
<ul>
<li>ä¸»è¦ç”¨äºç»†ç²’åº¦ç»†èŠ‚æå–ã€‚</li>
<li>åˆ†è¾¨ç‡å›ºå®šä¸º 352x352ã€‚</li>
</ul>
</li>
</ol>
<p><strong>ä»£ç ç¤ºä¾‹:</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># B=Batch size (e.g., 1)</span>
</span></span><span class="line"><span class="cl"><span class="n">x_dino</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">518</span><span class="p">,</span> <span class="mi">518</span><span class="p">)</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">x_sam</span>  <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">352</span><span class="p">,</span> <span class="mi">352</span><span class="p">)</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># æ³¨æ„å‚æ•°é¡ºåºï¼šå…ˆ dino (518)ï¼Œå sam (352)</span>
</span></span><span class="line"><span class="cl"><span class="n">out1</span><span class="p">,</span> <span class="n">out</span> <span class="c1"># B=Batch size (e.g., 1)</span>
</span></span><span class="line"><span class="cl"><span class="n">x_dino</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">518</span><span class="p">,</span> <span class="mi">518</span><span class="p">)</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">x_sam</span>  <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">352</span><span class="p">,</span> <span class="mi">352</span><span class="p">)</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># æ³¨æ„å‚æ•°é¡ºåºï¼šå…ˆ dino (518)ï¼Œå sam (352)</span>
</span></span><span class="line"><span class="cl"><span class="n">out1</span><span class="p">,</span> <span class="n">out2</span><span class="p">,</span> <span class="n">out3</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">x_dino</span><span class="p">,</span> <span class="n">x_sam</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>æ³¨æ„</strong>: åƒä¸‡ä¸è¦æåè¿™ä¸¤ä¸ªè¾“å…¥çš„é¡ºåºæˆ–åˆ†è¾¨ç‡ï¼Œå¦åˆ™ä¼šå¯¼è‡´ <code>RuntimeError</code>ï¼Œå› ä¸ºå†…éƒ¨çš„ç‰¹å¾èåˆå±‚ï¼ˆå¦‚ <code>dino2sam_down</code>ï¼‰æ˜¯é’ˆå¯¹è¿™ç§ç‰¹å®šçš„å°ºå¯¸æ¯”ä¾‹ç¡¬ç¼–ç çš„ã€‚<strong>æ³¨æ„</strong>: åƒä¸‡ä¸è¦æåè¿™ä¸¤ä¸ªè¾“å…¥çš„é¡ºåºæˆ–åˆ†è¾¨ç‡ï¼Œå¦åˆ™ä¼šå¯¼è‡´ <code>RuntimeError</code>ï¼Œå› ä¸ºå†…éƒ¨çš„ç‰¹å¾èåˆå±‚ï¼ˆå¦‚ <code>dino2sam_down</code>ï¼‰æ˜¯é’ˆå¯¹è¿™ç§ç‰¹å®šçš„å°ºå¯¸æ¯”ä¾‹ç¡¬ç¼–ç çš„ã€‚</p>
<p>è¿è¡Œä¸‹é¢çš„è„šæœ¬ï¼ŒæŸ¥çœ‹è¾“å…¥æ•°æ®åœ¨ç½‘ç»œä¸­çš„æµåŠ¨æƒ…å†µ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">torch</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">sam2dino_seg.DGSUNet</span> <span class="kn">import</span> <span class="n">DGSUNet</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">torchinfo</span> <span class="kn">import</span> <span class="n">summary</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">        <span class="n">dgsUnet</span> <span class="o">=</span> <span class="n">DGSUNet</span><span class="p">()</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">x_dino</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">518</span><span class="p">,</span> <span class="mi">518</span><span class="p">)</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">x_sam</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">352</span><span class="p">,</span> <span class="mi">352</span><span class="p">)</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># print(model)</span>
</span></span><span class="line"><span class="cl">        <span class="n">summary</span><span class="p">(</span><span class="n">dgsUnet</span><span class="p">,</span> <span class="n">input_data</span><span class="o">=</span><span class="p">(</span><span class="n">x_dino</span><span class="p">,</span> <span class="n">x_sam</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">out</span><span class="p">,</span> <span class="n">out1</span><span class="p">,</span> <span class="n">out2</span> <span class="o">=</span> <span class="n">dgsUnet</span><span class="p">(</span><span class="n">x_dino</span><span class="p">,</span> <span class="n">x_sam</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">out1</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">out2</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¾“å‡ºå¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">==============================================================================================================
</span></span><span class="line"><span class="cl">Layer (type:depth-idx)                                       Output Shape              Param #
</span></span><span class="line"><span class="cl">==============================================================================================================
</span></span><span class="line"><span class="cl">DGSUNet                                                      [1, 1, 352, 352]          --
</span></span><span class="line"><span class="cl">â”œâ”€sam2hiera: 1-1                                             [1, 144, 88, 88]          --
</span></span><span class="line"><span class="cl">â”‚    â””â”€Hiera: 2-1                                            [1, 144, 88, 88]          16,272
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€PatchEmbed: 3-1                                  [1, 88, 88, 144]          (21,312)
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€Sequential: 3-2                                  --                        213,826,128
</span></span><span class="line"><span class="cl">â”œâ”€DinoV2FeatureExtractor: 1-2                                [1, 1024, 37, 37]         --
</span></span><span class="line"><span class="cl">â”‚    â””â”€DinoVisionTransformer: 2-2                            --                        1,404,928
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€PatchEmbed: 3-3                                  [1, 1369, 1024]           (603,136)
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€ModuleList: 3-4                                  --                        (302,358,528)
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€LayerNorm: 3-5                                   [1, 1370, 1024]           (2,048)
</span></span><span class="line"><span class="cl">â”œâ”€interpolate_upsample: 1-3                                  [1, 1024, 11, 11]         --
</span></span><span class="line"><span class="cl">â”œâ”€DepthwiseSeparableConvWithWTConv2d: 1-4                    [1, 1152, 11, 11]         --
</span></span><span class="line"><span class="cl">â”‚    â””â”€WTConv2d: 2-3                                         [1, 1024, 11, 11]         32,768
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€ModuleList: 3-6                                  --                        36,864
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€ModuleList: 3-7                                  --                        4,096
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€Conv2d: 3-8                                      [1, 1024, 11, 11]         10,240
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€_ScaleModule: 3-9                                [1, 1024, 11, 11]         1,024
</span></span><span class="line"><span class="cl">â”‚    â””â”€Conv2d: 2-4                                           [1, 1152, 11, 11]         1,179,648
</span></span><span class="line"><span class="cl">â”‚    â””â”€BatchNorm2d: 2-5                                      [1, 1152, 11, 11]         2,304
</span></span><span class="line"><span class="cl">â”‚    â””â”€ReLU: 2-6                                             [1, 1152, 11, 11]         --
</span></span><span class="line"><span class="cl">â”œâ”€CGAFusion: 1-5                                             [1, 1152, 11, 11]         --
</span></span><span class="line"><span class="cl">â”‚    â””â”€ChannelAttention: 2-7                                 [1, 1152, 1, 1]           --
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€AdaptiveAvgPool2d: 3-10                          [1, 1152, 1, 1]           --
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€Sequential: 3-11                                 [1, 1152, 1, 1]           333,072
</span></span><span class="line"><span class="cl">â”‚    â””â”€SpatialAttention: 2-8                                 [1, 1, 11, 11]            --
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€Conv2d: 3-12                                     [1, 1, 11, 11]            99
</span></span><span class="line"><span class="cl">â”‚    â””â”€PixelAttention: 2-9                                   [1, 1152, 11, 11]         --
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€Conv2d: 3-13                                     [1, 1152, 11, 11]         114,048
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€Sigmoid: 3-14                                    [1, 1152, 11, 11]         --
</span></span><span class="line"><span class="cl">â”‚    â””â”€Sigmoid: 2-10                                         [1, 1152, 11, 11]         --
</span></span><span class="line"><span class="cl">â”‚    â””â”€Conv2d: 2-11                                          [1, 1152, 11, 11]         1,328,256
</span></span><span class="line"><span class="cl">â”œâ”€RFB_modified: 1-6                                          [1, 64, 88, 88]           --
</span></span><span class="line"><span class="cl">â”‚    â””â”€Sequential: 2-12                                      [1, 64, 88, 88]           --
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BasicConv2d: 3-15                                [1, 64, 88, 88]           9,344
</span></span><span class="line"><span class="cl">â”‚    â””â”€Sequential: 2-13                                      [1, 64, 88, 88]           --
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BasicConv2d: 3-16                                [1, 64, 88, 88]           9,344
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BasicConv2d: 3-17                                [1, 64, 88, 88]           12,416
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BasicConv2d: 3-18                                [1, 64, 88, 88]           12,416
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BasicConv2d: 3-19                                [1, 64, 88, 88]           36,992
</span></span><span class="line"><span class="cl">â”‚    â””â”€Sequential: 2-14                                      [1, 64, 88, 88]           --
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BasicConv2d: 3-20                                [1, 64, 88, 88]           9,344
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BasicConv2d: 3-21                                [1, 64, 88, 88]           20,608
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BasicConv2d: 3-22                                [1, 64, 88, 88]           20,608
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BasicConv2d: 3-23                                [1, 64, 88, 88]           36,992
</span></span><span class="line"><span class="cl">â”‚    â””â”€Sequential: 2-15                                      [1, 64, 88, 88]           --
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BasicConv2d: 3-24                                [1, 64, 88, 88]           9,344
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BasicConv2d: 3-25                                [1, 64, 88, 88]           28,800
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BasicConv2d: 3-26                                [1, 64, 88, 88]           28,800
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BasicConv2d: 3-27                                [1, 64, 88, 88]           36,992
</span></span><span class="line"><span class="cl">â”‚    â””â”€BasicConv2d: 2-16                                     [1, 64, 88, 88]           --
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€Conv2d: 3-28                                     [1, 64, 88, 88]           147,456
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BatchNorm2d: 3-29                                [1, 64, 88, 88]           128
</span></span><span class="line"><span class="cl">â”‚    â””â”€BasicConv2d: 2-17                                     [1, 64, 88, 88]           --
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€Conv2d: 3-30                                     [1, 64, 88, 88]           9,216
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BatchNorm2d: 3-31                                [1, 64, 88, 88]           128
</span></span><span class="line"><span class="cl">â”‚    â””â”€ReLU: 2-18                                            [1, 64, 88, 88]           --
</span></span><span class="line"><span class="cl">â”œâ”€RFB_modified: 1-7                                          [1, 64, 44, 44]           --
</span></span><span class="line"><span class="cl">â”‚    â””â”€Sequential: 2-19                                      [1, 64, 44, 44]           --
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BasicConv2d: 3-32                                [1, 64, 44, 44]           18,560
</span></span><span class="line"><span class="cl">â”‚    â””â”€Sequential: 2-20                                      [1, 64, 44, 44]           --
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BasicConv2d: 3-33                                [1, 64, 44, 44]           18,560
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BasicConv2d: 3-34                                [1, 64, 44, 44]           12,416
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BasicConv2d: 3-35                                [1, 64, 44, 44]           12,416
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BasicConv2d: 3-36                                [1, 64, 44, 44]           36,992
</span></span><span class="line"><span class="cl">â”‚    â””â”€Sequential: 2-21                                      [1, 64, 44, 44]           --
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BasicConv2d: 3-37                                [1, 64, 44, 44]           18,560
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BasicConv2d: 3-38                                [1, 64, 44, 44]           20,608
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BasicConv2d: 3-39                                [1, 64, 44, 44]           20,608
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BasicConv2d: 3-40                                [1, 64, 44, 44]           36,992
</span></span><span class="line"><span class="cl">â”‚    â””â”€Sequential: 2-22                                      [1, 64, 44, 44]           --
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BasicConv2d: 3-41                                [1, 64, 44, 44]           18,560
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BasicConv2d: 3-42                                [1, 64, 44, 44]           28,800
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BasicConv2d: 3-43                                [1, 64, 44, 44]           28,800
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BasicConv2d: 3-44                                [1, 64, 44, 44]           36,992
</span></span><span class="line"><span class="cl">â”‚    â””â”€BasicConv2d: 2-23                                     [1, 64, 44, 44]           --
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€Conv2d: 3-45                                     [1, 64, 44, 44]           147,456
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BatchNorm2d: 3-46                                [1, 64, 44, 44]           128
</span></span><span class="line"><span class="cl">â”‚    â””â”€BasicConv2d: 2-24                                     [1, 64, 44, 44]           --
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€Conv2d: 3-47                                     [1, 64, 44, 44]           18,432
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BatchNorm2d: 3-48                                [1, 64, 44, 44]           128
</span></span><span class="line"><span class="cl">â”‚    â””â”€ReLU: 2-25                                            [1, 64, 44, 44]           --
</span></span><span class="line"><span class="cl">â”œâ”€RFB_modified: 1-8                                          [1, 64, 22, 22]           --
</span></span><span class="line"><span class="cl">â”‚    â””â”€Sequential: 2-26                                      [1, 64, 22, 22]           --
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BasicConv2d: 3-49                                [1, 64, 22, 22]           36,992
</span></span><span class="line"><span class="cl">â”‚    â””â”€Sequential: 2-27                                      [1, 64, 22, 22]           --
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BasicConv2d: 3-50                                [1, 64, 22, 22]           36,992
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BasicConv2d: 3-51                                [1, 64, 22, 22]           12,416
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BasicConv2d: 3-52                                [1, 64, 22, 22]           12,416
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BasicConv2d: 3-53                                [1, 64, 22, 22]           36,992
</span></span><span class="line"><span class="cl">â”‚    â””â”€Sequential: 2-28                                      [1, 64, 22, 22]           --
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BasicConv2d: 3-54                                [1, 64, 22, 22]           36,992
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BasicConv2d: 3-55                                [1, 64, 22, 22]           20,608
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BasicConv2d: 3-56                                [1, 64, 22, 22]           20,608
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BasicConv2d: 3-57                                [1, 64, 22, 22]           36,992
</span></span><span class="line"><span class="cl">â”‚    â””â”€Sequential: 2-29                                      [1, 64, 22, 22]           --
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BasicConv2d: 3-58                                [1, 64, 22, 22]           36,992
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BasicConv2d: 3-59                                [1, 64, 22, 22]           28,800
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BasicConv2d: 3-60                                [1, 64, 22, 22]           28,800
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BasicConv2d: 3-61                                [1, 64, 22, 22]           36,992
</span></span><span class="line"><span class="cl">â”‚    â””â”€BasicConv2d: 2-30                                     [1, 64, 22, 22]           --
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€Conv2d: 3-62                                     [1, 64, 22, 22]           147,456
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BatchNorm2d: 3-63                                [1, 64, 22, 22]           128
</span></span><span class="line"><span class="cl">â”‚    â””â”€BasicConv2d: 2-31                                     [1, 64, 22, 22]           --
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€Conv2d: 3-64                                     [1, 64, 22, 22]           36,864
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BatchNorm2d: 3-65                                [1, 64, 22, 22]           128
</span></span><span class="line"><span class="cl">â”‚    â””â”€ReLU: 2-32                                            [1, 64, 22, 22]           --
</span></span><span class="line"><span class="cl">â”œâ”€RFB_modified: 1-9                                          [1, 64, 11, 11]           --
</span></span><span class="line"><span class="cl">â”‚    â””â”€Sequential: 2-33                                      [1, 64, 11, 11]           --
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BasicConv2d: 3-66                                [1, 64, 11, 11]           73,856
</span></span><span class="line"><span class="cl">â”‚    â””â”€Sequential: 2-34                                      [1, 64, 11, 11]           --
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BasicConv2d: 3-67                                [1, 64, 11, 11]           73,856
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BasicConv2d: 3-68                                [1, 64, 11, 11]           12,416
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BasicConv2d: 3-69                                [1, 64, 11, 11]           12,416
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BasicConv2d: 3-70                                [1, 64, 11, 11]           36,992
</span></span><span class="line"><span class="cl">â”‚    â””â”€Sequential: 2-35                                      [1, 64, 11, 11]           --
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BasicConv2d: 3-71                                [1, 64, 11, 11]           73,856
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BasicConv2d: 3-72                                [1, 64, 11, 11]           20,608
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BasicConv2d: 3-73                                [1, 64, 11, 11]           20,608
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BasicConv2d: 3-74                                [1, 64, 11, 11]           36,992
</span></span><span class="line"><span class="cl">â”‚    â””â”€Sequential: 2-36                                      [1, 64, 11, 11]           --
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BasicConv2d: 3-75                                [1, 64, 11, 11]           73,856
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BasicConv2d: 3-76                                [1, 64, 11, 11]           28,800
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BasicConv2d: 3-77                                [1, 64, 11, 11]           28,800
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BasicConv2d: 3-78                                [1, 64, 11, 11]           36,992
</span></span><span class="line"><span class="cl">â”‚    â””â”€BasicConv2d: 2-37                                     [1, 64, 11, 11]           --
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€Conv2d: 3-79                                     [1, 64, 11, 11]           147,456
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BatchNorm2d: 3-80                                [1, 64, 11, 11]           128
</span></span><span class="line"><span class="cl">â”‚    â””â”€BasicConv2d: 2-38                                     [1, 64, 11, 11]           --
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€Conv2d: 3-81                                     [1, 64, 11, 11]           73,728
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BatchNorm2d: 3-82                                [1, 64, 11, 11]           128
</span></span><span class="line"><span class="cl">â”‚    â””â”€ReLU: 2-39                                            [1, 64, 11, 11]           --
</span></span><span class="line"><span class="cl">â”œâ”€SFF: 1-10                                                  [1, 64, 22, 22]           --
</span></span><span class="line"><span class="cl">â”‚    â””â”€Sequential: 2-40                                      [1, 64, 22, 22]           --
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€Conv2d: 3-83                                     [1, 64, 22, 22]           4,096
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BatchNorm2d: 3-84                                [1, 64, 22, 22]           128
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€ReLU: 3-85                                       [1, 64, 22, 22]           --
</span></span><span class="line"><span class="cl">â”‚    â””â”€Sequential: 2-41                                      [1, 64, 22, 22]           --
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€Conv2d: 3-86                                     [1, 64, 22, 22]           4,096
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BatchNorm2d: 3-87                                [1, 64, 22, 22]           128
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€ReLU: 3-88                                       [1, 64, 22, 22]           --
</span></span><span class="line"><span class="cl">â”‚    â””â”€SelfAttentionBlock: 2-42                              [1, 64, 22, 22]           --
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€Sequential: 3-89                                 [1, 32, 22, 22]           3,200
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€Sequential: 3-90                                 [1, 32, 22, 22]           3,200
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€Sequential: 3-91                                 [1, 32, 22, 22]           2,112
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€Sequential: 3-92                                 [1, 64, 22, 22]           2,176
</span></span><span class="line"><span class="cl">â”‚    â””â”€Sequential: 2-43                                      [1, 64, 22, 22]           --
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€Conv2d: 3-93                                     [1, 64, 22, 22]           73,728
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BatchNorm2d: 3-94                                [1, 64, 22, 22]           128
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€ReLU: 3-95                                       [1, 64, 22, 22]           --
</span></span><span class="line"><span class="cl">â”œâ”€Conv2d: 1-11                                               [1, 1, 22, 22]            65
</span></span><span class="line"><span class="cl">â”œâ”€SFF: 1-12                                                  [1, 64, 44, 44]           --
</span></span><span class="line"><span class="cl">â”‚    â””â”€Sequential: 2-44                                      [1, 64, 44, 44]           --
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€Conv2d: 3-96                                     [1, 64, 44, 44]           4,096
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BatchNorm2d: 3-97                                [1, 64, 44, 44]           128
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€ReLU: 3-98                                       [1, 64, 44, 44]           --
</span></span><span class="line"><span class="cl">â”‚    â””â”€Sequential: 2-45                                      [1, 64, 44, 44]           --
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€Conv2d: 3-99                                     [1, 64, 44, 44]           4,096
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BatchNorm2d: 3-100                               [1, 64, 44, 44]           128
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€ReLU: 3-101                                      [1, 64, 44, 44]           --
</span></span><span class="line"><span class="cl">â”‚    â””â”€SelfAttentionBlock: 2-46                              [1, 64, 44, 44]           --
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€Sequential: 3-102                                [1, 32, 44, 44]           3,200
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€Sequential: 3-103                                [1, 32, 44, 44]           3,200
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€Sequential: 3-104                                [1, 32, 44, 44]           2,112
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€Sequential: 3-105                                [1, 64, 44, 44]           2,176
</span></span><span class="line"><span class="cl">â”‚    â””â”€Sequential: 2-47                                      [1, 64, 44, 44]           --
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€Conv2d: 3-106                                    [1, 64, 44, 44]           73,728
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BatchNorm2d: 3-107                               [1, 64, 44, 44]           128
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€ReLU: 3-108                                      [1, 64, 44, 44]           --
</span></span><span class="line"><span class="cl">â”œâ”€Conv2d: 1-13                                               [1, 1, 44, 44]            65
</span></span><span class="line"><span class="cl">â”œâ”€SFF: 1-14                                                  [1, 64, 88, 88]           --
</span></span><span class="line"><span class="cl">â”‚    â””â”€Sequential: 2-48                                      [1, 64, 88, 88]           --
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€Conv2d: 3-109                                    [1, 64, 88, 88]           4,096
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BatchNorm2d: 3-110                               [1, 64, 88, 88]           128
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€ReLU: 3-111                                      [1, 64, 88, 88]           --
</span></span><span class="line"><span class="cl">â”‚    â””â”€Sequential: 2-49                                      [1, 64, 88, 88]           --
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€Conv2d: 3-112                                    [1, 64, 88, 88]           4,096
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BatchNorm2d: 3-113                               [1, 64, 88, 88]           128
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€ReLU: 3-114                                      [1, 64, 88, 88]           --
</span></span><span class="line"><span class="cl">â”‚    â””â”€SelfAttentionBlock: 2-50                              [1, 64, 88, 88]           --
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€Sequential: 3-115                                [1, 32, 88, 88]           3,200
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€Sequential: 3-116                                [1, 32, 88, 88]           3,200
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€Sequential: 3-117                                [1, 32, 88, 88]           2,112
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€Sequential: 3-118                                [1, 64, 88, 88]           2,176
</span></span><span class="line"><span class="cl">â”‚    â””â”€Sequential: 2-51                                      [1, 64, 88, 88]           --
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€Conv2d: 3-119                                    [1, 64, 88, 88]           73,728
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€BatchNorm2d: 3-120                               [1, 64, 88, 88]           128
</span></span><span class="line"><span class="cl">â”‚    â”‚    â””â”€ReLU: 3-121                                      [1, 64, 88, 88]           --
</span></span><span class="line"><span class="cl">â”œâ”€Conv2d: 1-15                                               [1, 1, 88, 88]            65
</span></span><span class="line"><span class="cl">==============================================================================================================
</span></span><span class="line"><span class="cl">Total params: 523,776,534
</span></span><span class="line"><span class="cl">Trainable params: 7,225,830
</span></span><span class="line"><span class="cl">Non-trainable params: 516,550,704
</span></span><span class="line"><span class="cl">Total mult-adds (Units.GIGABYTES): 7.88
</span></span><span class="line"><span class="cl">==============================================================================================================
</span></span><span class="line"><span class="cl">Input size (MB): 4.71
</span></span><span class="line"><span class="cl">Forward/backward pass size (MB): 5799.91
</span></span><span class="line"><span class="cl">Params size (MB): 2089.29
</span></span><span class="line"><span class="cl">Estimated Total Size (MB): 7893.91
</span></span><span class="line"><span class="cl">==============================================================================================================
</span></span><span class="line"><span class="cl">torch.Size([1, 1, 352, 352]) torch.Size([1, 1, 352, 352]) torch.Size([1, 1, 352, 352])
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ç‰¹å¾æå–éƒ¨åˆ†ç»è¿‡ä¸€ä¸ª<code>CGA</code>æ¨¡å—èåˆä¸¤ä¸ªåˆ†æ”¯çš„ç‰¹å¾åï¼Œæœ€ç»ˆçš„å½¢çŠ¶ä¸º<code>[1, 1152, 11, 11]</code>ï¼Œè€Œæˆ‘ä»¬çš„ç›®æ ‡æ˜¯<code>[1, 256, 16, 16]</code>ï¼Œå› æ­¤éœ€è¦è¿›è¡Œç»´åº¦å¤„ç†ã€‚</p>
<blockquote>
<p>ä¸ºä»€ä¹ˆè¿™é‡Œä½¿ç”¨CGAèåˆæ¨¡å—ï¼Ÿ</p>
<p>åœ¨ <code>DGSUNet</code> ä¸­ä½¿ç”¨ <strong>CGAFusion</strong> (Cross-Guided Attention Fusion) æ¨¡å—ï¼Œæ˜¯ä¸ºäº†<strong>è‡ªé€‚åº”åœ°èåˆ</strong>æ¥è‡ª SAM2ï¼ˆä¾§é‡ç»†èŠ‚å’Œè¾¹ç•Œï¼‰ä¸ DiNOv2ï¼ˆä¾§é‡é«˜å±‚è¯­ä¹‰ï¼‰çš„ç‰¹å¾ã€‚</p>
<p>ç®€å•æ¥è¯´ï¼Œç®€å•çš„ç›¸åŠ æˆ–æ‹¼æ¥æ— æ³•åŒºåˆ†ä¸¤ä¸ªéª¨å¹²ç½‘ç»œçš„ä¼˜åŠ£ï¼Œè€Œ <code>CGAFusion</code> é€šè¿‡æ³¨æ„åŠ›æœºåˆ¶è®©ç½‘ç»œè‡ªå·±â€œå†³å®šâ€åœ¨æ¯ä¸ªåƒç´ ç‚¹ä¸Šæ›´åº”è¯¥ç›¸ä¿¡ SAM2 è¿˜æ˜¯ DiNOv2ã€‚</p>
<p>å…·ä½“åŸå› å’Œæœºåˆ¶å¦‚ä¸‹ï¼š</p>
<ol>
<li>
<p><strong>ç‰¹å¾ä¼˜åŠ¿äº’è¡¥</strong>ï¼š</p>
<ul>
<li><strong>SAM2 (x)</strong>ï¼šåœ¨åˆ†å‰²ä»»åŠ¡ä¸­ï¼Œæ“…é•¿æ•æ‰ç»†ç²’åº¦çš„è¾¹ç•Œå’Œå½¢çŠ¶ä¿¡æ¯ã€‚</li>
<li><strong>DiNOv2 (y)</strong>ï¼šåœ¨å¤§è§„æ¨¡æ•°æ®ä¸Šé¢„è®­ç»ƒï¼Œæ‹¥æœ‰æå¼ºçš„è¯­ä¹‰ç†è§£èƒ½åŠ›ã€‚</li>
<li><strong>CGAFusion</strong> çš„ä½œç”¨å°±æ˜¯å°†è¿™ä¸¤è€…çš„é•¿å¤„ç»“åˆèµ·æ¥ã€‚</li>
</ul>
</li>
<li>
<p><strong>ä¸‰ç»´æ³¨æ„åŠ›æœºåˆ¶ï¼ˆChannel, Spatial, Pixelï¼‰</strong>ï¼š
ä»£ç  (CGAFusion.py) æ˜¾ç¤ºè¯¥æ¨¡å—å®é™…ä¸Šä¸²è”äº†ä¸‰ç§æ³¨æ„åŠ›ï¼š</p>
<ul>
<li><strong>Channel Attention (<code>ca</code>)</strong>ï¼šè¯†åˆ«å“ªäº›ç‰¹å¾é€šé“æ›´é‡è¦ï¼ˆä¸»è¦å…³æ³¨â€œæ˜¯ä»€ä¹ˆâ€ï¼‰ã€‚</li>
<li><strong>Spatial Attention (<code>sa</code>)</strong>ï¼šè¯†åˆ«å›¾åƒä¸­å“ªäº›åŒºåŸŸæ›´é‡è¦ï¼ˆä¸»è¦å…³æ³¨â€œåœ¨å“ªé‡Œâ€ï¼‰ã€‚</li>
<li><strong>Pixel Attention (<code>pa</code>)</strong>ï¼šç»“åˆä¸Šè¿°ä¿¡æ¯ç”Ÿæˆåƒç´ çº§çš„æƒé‡å›¾ã€‚</li>
</ul>
</li>
<li>
<p><strong>é—¨æ§èåˆæœºåˆ¶ (Gated Fusion)</strong>ï¼š
æ¨¡å—æœ€æ ¸å¿ƒçš„å…¬å¼å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># pattn2 æ˜¯ç»è¿‡ Sigmoid ç”Ÿæˆçš„ 0~1 ä¹‹é—´çš„æƒé‡å›¾</span>
</span></span><span class="line"><span class="cl"><span class="n">result</span> <span class="o">=</span> <span class="n">initial</span> <span class="o">+</span> <span class="n">pattn2</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">pattn2</span><span class="p">)</span> <span class="o">*</span> <span class="n">y</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>è¿™æ„å‘³ç€ç½‘ç»œä¸ºæ¯ä¸ªä½ç½®ç”Ÿæˆäº†ä¸€ä¸ªæƒé‡ <code>pattn2</code>ã€‚</li>
<li>å¦‚æœ <code>pattn2</code> æ¥è¿‘ 1ï¼Œä¸»è¦ä¿ç•™ <strong>SAM2 (x)</strong> çš„ç‰¹å¾ã€‚</li>
<li>å¦‚æœ <code>pattn2</code> æ¥è¿‘ 0ï¼Œä¸»è¦ä¿ç•™ <strong>DiNOv2 (y)</strong> çš„ç‰¹å¾ã€‚</li>
<li>è¿™ç§è½¯é€‰æ‹©ï¼ˆSoft Selectionï¼‰æœºåˆ¶æ¯”ç¡¬æ€§çš„ <code>Add</code> æˆ– <code>Concat</code> æ›´çµæ´»ï¼Œèƒ½æœ‰æ•ˆå‡å°‘ç‰¹å¾å†²çªã€‚</li>
</ul>
</li>
</ol>
<p><strong>æ€»ç»“ï¼š</strong>
ä½¿ç”¨ CGAFusion æ˜¯ä¸ºäº†<strong>æ™ºèƒ½åœ°</strong>è§£å†³åŒéª¨å¹²ç½‘ç»œï¼ˆDual Backboneï¼‰ç‰¹å¾èåˆçš„é—®é¢˜ï¼Œç¡®ä¿æ¨¡å‹æ—¢æœ‰ SAM2 çš„ç²¾å‡†è¾¹ç¼˜ï¼Œåˆæœ‰ DiNOv2 çš„ä¸°å¯Œè¯­ä¹‰ã€‚</p>
</blockquote>
<h3 id="å¼€å§‹ä¿®æ”¹">å¼€å§‹ä¿®æ”¹
</h3><p>å¥½åƒCGAåªèƒ½å¤„ç†åŒéª¨å¹²ç½‘ç»œï¼Œå¦åˆ™å°±è¦ä¿®æ”¹åŸå§‹<code>CGAFusion</code>çš„ä»£ç äº†ã€‚è¦ä¸æ¢ä¸ªæ€è·¯ï¼ŒæŠ›å¼ƒä¸‰åˆ†æ”¯ï¼Œç›´æ¥ä½¿ç”¨DSU-Netçš„éª¨å¹²ç½‘ç»œã€‚</p>
<p>å¥½å§ï¼Œå‚è€ƒäº†ä¸€ä¸‹aiçš„æ„è§ï¼Œå®ƒå»ºè®®æˆ‘å°†<code>DSGC-Net</code>éª¨å¹²ç½‘ç»œæ›¿æ¢ä¸º<code>DSU-Net</code>çš„éª¨å¹²ç½‘ç»œã€‚å¦‚æœè¿™æ ·çš„è¯å°±è¦ä¿®æ”¹æ•°æ®é¢„å¤„ç†çš„ä»£ç ï¼Œ</p>
<p>æ¬¸ï¼Œ<code>DSU-Net</code>ä¸­æœ‰ä¸ª<code>RFB</code>æ¨¡å—å¾ˆæœ‰æ„æ€ï¼Œä¼¼ä¹èƒ½è°ƒæ•´é€šé“æ•°ã€‚</p>
<blockquote>
<p><strong>RFB (Receptive Field Block)</strong> æ¨¡å—çš„ä¸»è¦ä½œç”¨æ˜¯<strong>å¢å¼ºç‰¹å¾æå–èƒ½åŠ›</strong>ï¼Œé€šè¿‡æ¨¡æ‹Ÿäººç±»è§†è§‰çš„æ„Ÿå—é‡æœºåˆ¶ï¼Œä½¿ç½‘ç»œèƒ½å¤ŸåŒæ—¶æ•è·å¤šå°ºåº¦çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚</p>
<p>åœ¨è¿™ä¸ª <code>DGSUNet</code> ç½‘ç»œä¸­ï¼ŒRFB æ¨¡å—å…·ä½“æ‰®æ¼”äº†ä»¥ä¸‹ä¸¤ä¸ªå…³é”®è§’è‰²ï¼š</p>
<ol>
<li>æ‰©å¤§æ„Ÿå—é‡ (Expand Receptive Field)
ä»£ç æ˜¾ç¤º <code>RFB_modified</code> åŒ…å«å››ä¸ªå¹¶è¡Œçš„åˆ†æ”¯ (<code>branch0</code> ~ <code>branch3</code>)ï¼Œå®ƒä»¬ä½¿ç”¨äº†ä¸åŒçš„è†¨èƒ€å·ç§¯ï¼ˆDilated Convolutionï¼‰ç‡ï¼š</li>
</ol>
<ul>
<li><strong>Branch 0</strong>: 1x1 å·ç§¯ï¼ˆåŸºç¡€ç‰¹å¾ï¼‰ã€‚</li>
<li><strong>Branch 1</strong>: è†¨èƒ€ç‡ <code>dilation=3</code>ã€‚</li>
<li><strong>Branch 2</strong>: è†¨èƒ€ç‡ <code>dilation=5</code>ã€‚</li>
<li><strong>Branch 3</strong>: è†¨èƒ€ç‡ <code>dilation=7</code>ã€‚</li>
</ul>
<p>é€šè¿‡å°†è¿™äº›ä¸åŒâ€œè§†é‡â€èŒƒå›´æå–åˆ°çš„ç‰¹å¾æ‹¼æ¥åœ¨ä¸€èµ·ï¼Œç½‘ç»œæ—¢èƒ½çœ‹åˆ°å±€éƒ¨ç»†èŠ‚ï¼ˆå°æ„Ÿå—é‡ï¼‰ï¼Œä¹Ÿèƒ½æ„ŸçŸ¥æ›´å¤§çš„ä¸Šä¸‹æ–‡ç¯å¢ƒï¼ˆå¤§æ„Ÿå—é‡ï¼‰ï¼Œè¿™å¯¹äºåˆ†å‰²ä¸åŒå¤§å°çš„ç›®æ ‡è‡³å…³é‡è¦ã€‚</p>
<ol start="2">
<li>ç»Ÿä¸€é€šé“æ•° (Channel Adaptation)
åœ¨ DGSUNet.py ä¸­ï¼Œä½ å¯ä»¥çœ‹åˆ° RFB è¿æ¥åœ¨éª¨å¹²ç½‘ç»œï¼ˆBackboneï¼‰å’Œè§£ç å™¨ï¼ˆDecoderï¼‰ä¹‹é—´ï¼š</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># éª¨å¹²ç½‘ç»œè¾“å‡ºçš„ä¸åŒå°ºåº¦çš„é€šé“æ•°</span>
</span></span><span class="line"><span class="cl"><span class="c1"># x1: 144, x2: 288, x3: 576, x4: 1152</span>
</span></span><span class="line"><span class="cl"><span class="bp">self</span><span class="o">.</span><span class="n">rfb1</span> <span class="o">=</span> <span class="n">RFB</span><span class="o">.</span><span class="n">RFB_modified</span><span class="p">(</span><span class="mi">144</span><span class="p">,</span> <span class="mi">64</span><span class="p">)</span>   <span class="c1"># è¾“å‡º 64</span>
</span></span><span class="line"><span class="cl"><span class="bp">self</span><span class="o">.</span><span class="n">rfb2</span> <span class="o">=</span> <span class="n">RFB</span><span class="o">.</span><span class="n">RFB_modified</span><span class="p">(</span><span class="mi">288</span><span class="p">,</span> <span class="mi">64</span><span class="p">)</span>   <span class="c1"># è¾“å‡º 64</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ...</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å®ƒå°†éª¨å¹²ç½‘ç»œè¾“å‡ºçš„<strong>ä¸ä¸€è‡´çš„é€šé“æ•°</strong>ï¼ˆå¦‚ 144, 288, 576, 1152ï¼‰å…¨éƒ¨é™ç»´å¹¶ç»Ÿæ˜ å°„åˆ° <strong>64</strong> ä¸ªé€šé“ã€‚è¿™æ ·åšæ˜¯ä¸ºäº†æ–¹ä¾¿åç»­è§£ç å™¨ (<code>SFF</code> æ¨¡å—) è¿›è¡Œé€çº§ä¸Šé‡‡æ ·å’Œèåˆã€‚</p>
<p>æ€»ç»“
ç®€å•æ¥è¯´ï¼ŒRFB åœ¨è¿™é‡Œèµ·åˆ°äº† <strong>â€œæ‰¿ä¸Šå¯ä¸‹â€</strong> çš„ä½œç”¨ï¼š</p>
<ul>
<li><strong>æ‰¿ä¸Š</strong>ï¼šæ¥æ”¶éª¨å¹²ç½‘ç»œçš„ç‰¹å¾ï¼Œåˆ©ç”¨å¤šåˆ†æ”¯ç©ºæ´å·ç§¯ä½¿å…¶åŒ…å«æ›´ä¸°å¯Œçš„å°ºåº¦ä¿¡æ¯ã€‚</li>
<li><strong>å¯ä¸‹</strong>ï¼šæŠŠç‰¹å¾å‹ç¼©æˆç»Ÿä¸€çš„åšåº¦ï¼ˆChannel=64ï¼‰ï¼Œå–‚ç»™è§£ç å™¨ç”Ÿæˆæœ€ç»ˆçš„åˆ†å‰²å›¾ã€‚</li>
</ul>
</blockquote>
<p>é€šè¿‡è¿™ä¸ªæ¨¡å—ä¸å°±å¯ä»¥è®©<code>channels=1152</code>å˜æˆ<code>channels=256</code>å—ï¼Ÿ</p>
<p>æ‰€ä»¥ç°åœ¨å”¯ä¸€çš„éš¾ç‚¹å°±æ˜¯æ€æ ·å°†<strong>output_size = [11, 11] -&gt; output_size = [16, 16]</strong></p>
<p>è¿™ä¸ªè§£å†³èµ·æ¥ä¹Ÿç®€å•ï¼Œç»è¿‡ä¸€ä¸ª<code>nn.Upsample(size=(16, 16))</code>å°±èƒ½è§£å†³å…³é”®æ˜¯ï¼Œä¿®æ”¹æ•°æ®åŠ è½½æ¨¡å—ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">random</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">torch</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">torchvision.transforms</span> <span class="k">as</span> <span class="nn">transforms</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">Dataset</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">cv2</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">scipy.io</span> <span class="k">as</span> <span class="nn">io</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># ã€å»ºè®®1ã€‘å®šä¹‰å…¨å±€ CROP_SIZEï¼Œæ–¹ä¾¿ç»Ÿä¸€ä¿®æ”¹</span>
</span></span><span class="line"><span class="cl"><span class="c1"># CROP_SIZE å¿…é¡»èƒ½è¢« 32 æ•´é™¤ (Patch Size 14 * 16 = 224 æ˜¯æœ€ç†æƒ³çš„)</span>
</span></span><span class="line"><span class="cl"><span class="n">CROP_SIZE</span> <span class="o">=</span> <span class="mi">224</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">SHHA</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_root</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">patch</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">flip</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">root_path</span> <span class="o">=</span> <span class="n">data_root</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">train_lists</span> <span class="o">=</span> <span class="s2">&#34;train.txt&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">eval_list</span> <span class="o">=</span> <span class="s2">&#34;test.txt&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">gt_density</span> <span class="o">=</span> <span class="s2">&#34;gt_density_maps&#34;</span> 
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">img_list_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_lists</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">train</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">img_list_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_lists</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">gt_dmap_root</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gt_density</span><span class="p">,</span><span class="s1">&#39;train&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">img_list_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_list</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">img_map</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">img_list</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">train_list</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img_list_file</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">train_list</span> <span class="o">=</span> <span class="n">train_list</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_path</span><span class="p">,</span> <span class="n">train_list</span><span class="p">))</span> <span class="k">as</span> <span class="n">fin</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fin</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span> 
</span></span><span class="line"><span class="cl">                        <span class="k">continue</span>
</span></span><span class="line"><span class="cl">                    <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                    <span class="bp">self</span><span class="o">.</span><span class="n">img_map</span><span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_path</span><span class="p">,</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())]</span> <span class="o">=</span> \
</span></span><span class="line"><span class="cl">                                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_path</span><span class="p">,</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">img_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img_map</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">nSamples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img_list</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">transform</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">train</span> <span class="o">=</span> <span class="n">train</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">patch</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">flip</span> <span class="o">=</span> <span class="n">flip</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">nSamples</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span> <span class="n">index</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="s1">&#39;index range error&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="n">img_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_list</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">gt_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_map</span><span class="p">[</span><span class="n">img_path</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">imgname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">train</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">gt_dmap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gt_dmap_root</span><span class="p">,</span><span class="n">imgname</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.jpg&#39;</span><span class="p">,</span><span class="s1">&#39;.npy&#39;</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">            <span class="n">gt_dmap</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">gt_dmap</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">gt_dmap1</span> <span class="o">=</span> <span class="n">gt_dmap</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">img</span><span class="p">,</span> <span class="n">point</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">((</span><span class="n">img_path</span><span class="p">,</span> <span class="n">gt_path</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">train</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">train</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">augmentation</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span>
</span></span><span class="line"><span class="cl">                <span class="n">transforms</span><span class="o">.</span><span class="n">RandomApply</span><span class="p">([</span>
</span></span><span class="line"><span class="cl">                    <span class="n">transforms</span><span class="o">.</span><span class="n">ColorJitter</span><span class="p">(</span><span class="n">brightness</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">contrast</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">saturation</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="p">],</span> <span class="n">p</span><span class="o">=</span><span class="mf">0.5</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="n">transforms</span><span class="o">.</span><span class="n">RandomGrayscale</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">])</span>
</span></span><span class="line"><span class="cl">            <span class="n">img</span> <span class="o">=</span> <span class="n">augmentation</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">train</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">scale_range</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.7</span><span class="p">,</span> <span class="mf">1.3</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="n">min_size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
</span></span><span class="line"><span class="cl">            <span class="n">scale</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">*</span><span class="n">scale_range</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># ã€ä¿®æ”¹2ã€‘è°ƒæ•´ç¼©æ”¾é€»è¾‘ä¸­çš„æœ€å°å°ºå¯¸åˆ¤æ–­</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># å¿…é¡»ä¿è¯ç¼©æ”¾åçš„å›¾ç‰‡è‡³å°‘æ¯” CROP_SIZE å¤§ï¼Œå¦åˆ™ random_crop ä¼šæŠ¥é”™</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">scale</span> <span class="o">*</span> <span class="n">min_size</span> <span class="o">&gt;</span> <span class="n">CROP_SIZE</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">img</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">upsample_bilinear</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">scale_factor</span><span class="o">=</span><span class="n">scale</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">gt_dmap1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">upsample_bilinear</span><span class="p">(</span><span class="n">gt_dmap1</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">scale_factor</span><span class="o">=</span><span class="n">scale</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">gt_dmap1</span> <span class="o">=</span> <span class="n">gt_dmap1</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">gt_dmap1</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">gt_dmap</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">point</span> <span class="o">*=</span> <span class="n">scale</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">train</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">img_with_density</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">img</span><span class="p">,</span> <span class="n">gt_dmap1</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">train</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">patch</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">img_with_density</span><span class="p">,</span> <span class="n">point</span> <span class="o">=</span> <span class="n">random_crop</span><span class="p">(</span><span class="n">img_with_density</span><span class="p">,</span> <span class="n">point</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">point</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">point</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">point</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># ã€ä¿®æ”¹3ã€‘Flip å’Œ Crop åçš„ç‚¹åæ ‡å½’ä¸€åŒ–ä¿®æ­£</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># åŸä»£ç ç¡¬ç¼–ç äº† 128 (`point[i][:, 0] = 128 - ...`)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># ç°åœ¨å¿…é¡»æ”¹ä¸º CROP_SIZE (224)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">0.5</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">train</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">flip</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">img_with_density</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">img_with_density</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">point</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">point</span><span class="p">[</span><span class="n">i</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">CROP_SIZE</span> <span class="o">-</span> <span class="n">point</span><span class="p">[</span><span class="n">i</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">train</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">img</span> <span class="o">=</span> <span class="n">img_with_density</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
</span></span><span class="line"><span class="cl">            <span class="n">density</span> <span class="o">=</span> <span class="n">img_with_density</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span>
</span></span><span class="line"><span class="cl">            <span class="n">density</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">density</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">train</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">point</span> <span class="o">=</span> <span class="p">[</span><span class="n">point</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">img</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">target</span> <span class="o">=</span> <span class="p">[{}</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">point</span><span class="p">))]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">point</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">target</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;point&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">point</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">            <span class="n">image_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">img_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">            <span class="n">image_id</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">([</span><span class="n">image_id</span><span class="p">])</span><span class="o">.</span><span class="n">long</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="n">target</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;image_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">image_id</span>
</span></span><span class="line"><span class="cl">            <span class="n">target</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">point</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span><span class="o">.</span><span class="n">long</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">train</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># ã€ä¿®æ”¹4ã€‘ ç”Ÿæˆ Density Map æ ‡ç­¾çš„ä¸‹é‡‡æ ·å€ç‡ä¿®æ­£</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># åŸæœ¬: 128 -&gt; 16 (å€ç‡8)</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># ç°åœ¨: 224 -&gt; 16 (å€ç‡14) -&gt; è¿™ä¼šå¯¼è‡´ label å’Œ output ä¸åŒ¹é…ï¼</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># </span>
</span></span><span class="line"><span class="cl">            <span class="c1"># å…³é”®å†³ç­–ï¼šä½ çš„ DSGCNet è¾“å‡ºæ˜¯å¼ºåˆ¶å¯¹é½åˆ° 16x16 çš„ã€‚</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># æ‰€ä»¥è¿™é‡Œ GT çš„ç”Ÿæˆä¹Ÿå¿…é¡»æ˜¯ 16x16ã€‚</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># åŸä»£ç é€»è¾‘ï¼škernel size = 128 / 16 = 8ã€‚</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># æ–°ä»£ç é€»è¾‘ï¼škernel size = 224 / 16 = 14ã€‚</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="n">density_images</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">density</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">density</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># è®¡ç®—ä¸‹é‡‡æ ·å¿«çš„å¤§å°ï¼ˆStrideï¼‰ï¼š224 // 16 = 14</span>
</span></span><span class="line"><span class="cl">            <span class="n">stride</span> <span class="o">=</span> <span class="n">CROP_SIZE</span> <span class="o">//</span> <span class="mi">16</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">density</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
</span></span><span class="line"><span class="cl">                <span class="n">density_img</span> <span class="o">=</span> <span class="n">density</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># Sum pooling: å°† 224x224 å—åŠ å’Œæˆ 16x16</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># æ³¨æ„ reshape å‚æ•°ï¼š(H_out, Stride, W_out, Stride)</span>
</span></span><span class="line"><span class="cl">                <span class="n">resized_img</span> <span class="o">=</span> <span class="n">density_img</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="mi">16</span><span class="p">,</span> <span class="n">stride</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">stride</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="n">density_images</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">resized_img</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">train</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">img</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">density_images</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">img</span><span class="p">,</span> <span class="n">target</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">load_data</span><span class="p">(</span><span class="n">img_gt_path</span><span class="p">,</span> <span class="n">train</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">img_path</span><span class="p">,</span> <span class="n">gt_path</span> <span class="o">=</span> <span class="n">img_gt_path</span>
</span></span><span class="line"><span class="cl">    <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2RGB</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">points</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># æ”¯æŒ.matå’Œ.txtä¸¤ç§æ ¼å¼</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">gt_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.mat&#39;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># å¤„ç†.matæ ¼å¼ï¼ˆShanghaiTechåŸå§‹æ ¼å¼ï¼‰</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">mat</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">loadmat</span><span class="p">(</span><span class="n">gt_path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># ShanghaiTech Part Aæ ¼å¼: image_info[0,0][0,0][0]</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="s1">&#39;image_info&#39;</span> <span class="ow">in</span> <span class="n">mat</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">points_data</span> <span class="o">=</span> <span class="n">mat</span><span class="p">[</span><span class="s2">&#34;image_info&#34;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">points_data</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">                    <span class="n">points</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">points_data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">points_data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">])])</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># å…¶ä»–å¯èƒ½çš„.matæ ¼å¼</span>
</span></span><span class="line"><span class="cl">            <span class="k">elif</span> <span class="s1">&#39;annPoints&#39;</span> <span class="ow">in</span> <span class="n">mat</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">points_data</span> <span class="o">=</span> <span class="n">mat</span><span class="p">[</span><span class="s1">&#39;annPoints&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">points_data</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">                    <span class="n">points</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">points_data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">points_data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">])])</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># å¦‚æœpointsç›´æ¥æ˜¯æ•°ç»„</span>
</span></span><span class="line"><span class="cl">            <span class="k">elif</span> <span class="s1">&#39;points&#39;</span> <span class="ow">in</span> <span class="n">mat</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">points_data</span> <span class="o">=</span> <span class="n">mat</span><span class="p">[</span><span class="s1">&#39;points&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">points_data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">points_data</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">                        <span class="n">points</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">points_data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">points_data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">])])</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Warning: Failed to load .mat file </span><span class="si">{</span><span class="n">gt_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Trying to read as txt format...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># å¦‚æœè¯»å–å¤±è´¥ï¼Œå°è¯•ä½œä¸ºtxtå¤„ç†</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">gt_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f_label</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f_label</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                            <span class="k">continue</span>
</span></span><span class="line"><span class="cl">                        <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                            <span class="n">x</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">                            <span class="n">y</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">                            <span class="n">points</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">            <span class="k">except</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Error: Cannot read annotation file </span><span class="si">{</span><span class="n">gt_path</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># å¤„ç†.txtæ ¼å¼</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">gt_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f_label</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f_label</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="k">continue</span>
</span></span><span class="line"><span class="cl">                    <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">x</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">                        <span class="n">y</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">                        <span class="n">points</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Error: Failed to load .txt file </span><span class="si">{</span><span class="n">gt_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">img</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">points</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">random_crop</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">den</span><span class="p">,</span> <span class="n">num_patch</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># ã€ä¿®æ”¹5ã€‘random_crop çš„å°ºå¯¸ä¹Ÿå¿…é¡»åŒæ­¥ä¿®æ”¹</span>
</span></span><span class="line"><span class="cl">    <span class="n">half_h</span> <span class="o">=</span> <span class="n">CROP_SIZE</span>
</span></span><span class="line"><span class="cl">    <span class="n">half_w</span> <span class="o">=</span> <span class="n">CROP_SIZE</span>
</span></span><span class="line"><span class="cl">    <span class="n">result_img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">num_patch</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">half_h</span><span class="p">,</span> <span class="n">half_w</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="n">result_den</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># é˜²æ­¢æå°‘æ•°æƒ…å†µä¸‹å›¾ç‰‡å°äº crop size å¯¼è‡´æŠ¥é”™</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># ç†è®ºä¸Šå‰é¢çš„ scale é€»è¾‘å·²ç»ä¿æŠ¤äº†ï¼Œä½†è¿™é‡ŒåŠ ä¸ªå®‰å…¨å…œåº•</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">half_h</span> <span class="ow">or</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">half_w</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">       <span class="c1"># å¦‚æœçœŸçš„æ¯” 224 è¿˜è¦å°ï¼Œå°±åªèƒ½ Padding æˆ–è€… Resize ç¡¬æ‹‰</span>
</span></span><span class="line"><span class="cl">       <span class="c1"># ç®€å•ç­–ç•¥ï¼šPad 0 è¡¥é½</span>
</span></span><span class="line"><span class="cl">       <span class="n">pad_h</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">half_h</span> <span class="o">-</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">       <span class="n">pad_w</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">half_w</span> <span class="o">-</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">       <span class="n">img</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">pad_w</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pad_h</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_patch</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">start_h</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">half_h</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">start_w</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">half_w</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">end_h</span> <span class="o">=</span> <span class="n">start_h</span> <span class="o">+</span> <span class="n">half_h</span>
</span></span><span class="line"><span class="cl">        <span class="n">end_w</span> <span class="o">=</span> <span class="n">start_w</span> <span class="o">+</span> <span class="n">half_w</span>
</span></span><span class="line"><span class="cl">        <span class="n">result_img</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">img</span><span class="p">[:,</span> <span class="n">start_h</span><span class="p">:</span><span class="n">end_h</span><span class="p">,</span> <span class="n">start_w</span><span class="p">:</span><span class="n">end_w</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">den</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">start_w</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">den</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">end_w</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">den</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">start_h</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">den</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">end_h</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">record_den</span> <span class="o">=</span> <span class="n">den</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">record_den</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="n">start_w</span>
</span></span><span class="line"><span class="cl">        <span class="n">record_den</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-=</span> <span class="n">start_h</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">result_den</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">record_den</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">result_img</span><span class="p">,</span> <span class="n">result_den</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>ä¸ºä»€ä¹ˆè¦è¿™æ ·ä¿®æ”¹?</p>
<p>è¿™æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„é—®é¢˜ï¼ç†è§£â€œä¸ºä»€ä¹ˆè¦æ”¹â€æ¯”â€œçŸ¥é“æ€ä¹ˆæ”¹â€æ›´é‡è¦ï¼Œå› ä¸ºè¿™æ¶‰åŠåˆ°æ·±åº¦å­¦ä¹ ä¸­æ•°æ®ã€æ¨¡å‹å’ŒæŸå¤±å‡½æ•°ä¹‹é—´çš„<u>å¯¹é½ï¼ˆAlignmentï¼‰</u>åŸåˆ™ã€‚</p>
<p>ä¹‹æ‰€ä»¥è¦è¿™æ”¹è¿™ 5 å¤„ä»£ç ï¼Œæ˜¯å› ä¸ºä½ æŠŠæ¨¡å‹çš„è¾“å…¥å°ºå¯¸ï¼ˆInput Sizeï¼‰ä» <strong>128 æ”¹ä¸ºäº† 224</strong>ã€‚è¿™ä¸€å˜åŠ¨å¼•å‘äº†<strong>è¿é”ååº”</strong>ï¼Œå¿…é¡»åœ¨æ•°æ®å¤„ç†çš„æ¯ä¸€ä¸ªç¯èŠ‚éƒ½è¿›è¡ŒåŒæ­¥è°ƒæ•´ï¼Œå¦åˆ™ä¼šå¯¼è‡´æ¨¡å‹â€œçœ‹â€åˆ°çš„æ˜¯é”™çš„å›¾ç‰‡ï¼Œæˆ–è€…â€œå­¦â€åˆ°çš„æ˜¯é”™çš„æ ‡ç­¾ã€‚</p>
<p>æˆ‘æŠŠè¿™ 5 ä¸ªä¿®æ”¹ç‚¹èƒŒåçš„<strong>æ•°å­¦å’Œé€»è¾‘åŸå› </strong>æ‹†è§£ç»™ä½ çœ‹ï¼š</p>
<hr>
<ol>
<li>ä¿®æ”¹ <code>random_crop</code> å‡½æ•°ä¸­çš„å°ºå¯¸ (128 -&gt; 224)</li>
</ol>
<ul>
<li><strong>åŸå› </strong>ï¼šä¸ºäº†å–‚ç»™ Transformer (ViT) éª¨å¹²ç½‘ç»œã€‚</li>
<li><strong>è§£é‡Š</strong>ï¼šDSU-Net ç”¨çš„ Dinov2 å’Œ SAM2 æ˜¯åŸºäº Vision Transformer çš„ã€‚å®ƒä»¬æŠŠå›¾ç‰‡åˆ‡æˆä¸€ä¸ªä¸ª $14 \times 14$ çš„å°æ–¹å—ï¼ˆPatchï¼‰ã€‚
<ul>
<li>å¦‚æœä½ ç”¨åŸæ¥çš„ <strong>128</strong>ï¼š$128 \div 14 \approx 9.14$ã€‚åˆ‡ä¸æ•´é½ï¼Œè¾¹ç¼˜å¿…é¡»è¡¥é›¶ï¼ˆPaddingï¼‰ï¼Œè¿™ä¼šå¼•å…¥æ— æ„ä¹‰çš„é»‘è¾¹ï¼Œå¹²æ‰°ç‰¹å¾æå–ã€‚</li>
<li>æ”¹ä¸º <strong>224</strong>ï¼š$224 \div 14 = 16$ã€‚åˆšå¥½åˆ‡æˆ $16 \times 16$ ä¸ª Patchï¼Œå®Œç¾é€‚é…ã€‚è¿™ä¹Ÿæ˜¯ ImageNet é¢„è®­ç»ƒçš„æ ‡å‡†å°ºå¯¸ã€‚</li>
</ul>
</li>
</ul>
<ol start="2">
<li>ä¿®æ”¹ Scale ç¼©æ”¾é€»è¾‘ (<code>&gt; CROP_SIZE</code>)</li>
</ol>
<ul>
<li><strong>åŸå› </strong>ï¼šé˜²æ­¢ç¨‹åºå´©æºƒï¼ˆIndex Errorï¼‰ã€‚</li>
<li><strong>è§£é‡Š</strong>ï¼š<code>random_crop</code> æ˜¯ä»å¤§å›¾é‡ŒéšæœºæŠ ä¸€ä¸ªå°å›¾ã€‚
<ul>
<li>å¦‚æœä½ æŠŠå›¾ç¼©æ”¾åˆ°åªå‰© 150 åƒç´ å®½ï¼Œç„¶åè®©ç¨‹åºå»æŠ ä¸€ä¸ª 224 åƒç´ çš„å—ï¼Œç¨‹åºå°±ä¼šæŠ¥é”™ï¼ˆå› ä¸ºå›¾ä¸å¤Ÿå¤§ï¼ŒæŠ ä¸å‡ºæ¥ï¼‰ã€‚</li>
<li>å› æ­¤ï¼Œå¿…é¡»ä¿è¯ç¼©æ”¾åçš„å›¾<strong>è‡³å°‘</strong>æ¯”æˆ‘ä»¬è¦æŠ çš„å°ºå¯¸ï¼ˆ224ï¼‰å¤§ã€‚</li>
</ul>
</li>
</ul>
<ol start="3">
<li>ä¿®æ”¹ Flip ç¿»è½¬åæ ‡ (<code>CROP_SIZE - x</code>)</li>
</ol>
<ul>
<li><strong>åŸå› </strong>ï¼šä¿è¯åæ ‡å˜æ¢çš„å‡ ä½•æ­£ç¡®æ€§ã€‚</li>
<li><strong>è§£é‡Š</strong>ï¼šè¿™å°±åƒç…§é•œå­ã€‚
<ul>
<li>å¦‚æœä½ åœ¨ä¸€å¼ å®½ 128 çš„çº¸ä¸Šç”»ä¸ªç‚¹ï¼Œåæ ‡æ˜¯ $x=10$ã€‚æ°´å¹³ç¿»è½¬åï¼Œæ–°åæ ‡æ˜¯ $128 - 10 = 118$ã€‚</li>
<li>ç°åœ¨çº¸å˜å®½äº†ï¼ˆ224ï¼‰ï¼ŒåŒæ ·çš„ç¿»è½¬ï¼Œæ–°åæ ‡åº”è¯¥æ˜¯ $224 - 10 = 214$ã€‚</li>
<li>å¦‚æœä½ è¿˜ç”¨æ—§å…¬å¼ $128 - 10 = 118$ï¼Œè¿™ä¸ªç‚¹å°±è·‘åˆ°å›¾ç‰‡ä¸­é—´å·¦è¾¹å»äº†ï¼Œè€Œå›¾ç‰‡å†…å®¹å…¶å®å·²ç»ç¿»è½¬åˆ°äº†æœ€å³è¾¹ã€‚<strong>ç‚¹å’Œäººå°±å¯¹ä¸ä¸Šäº†</strong>ï¼Œæ¨¡å‹ä¼šå­¦åºŸã€‚</li>
</ul>
</li>
</ul>
<ol start="4">
<li>ä¿®æ”¹ GT Density Map ç”Ÿæˆé€»è¾‘ (Sum Pooling Stride)</li>
</ol>
<ul>
<li><strong>è¿™æ˜¯æœ€å…³é”®çš„ä¿®æ”¹ï¼</strong></li>
<li><strong>åŸå› </strong>ï¼šä¿è¯ Ground Truth (æ ‡ç­¾) å’Œ æ¨¡å‹é¢„æµ‹è¾“å‡º (Prediction) çš„<strong>æ€»èƒ½é‡å®ˆæ’</strong>ã€‚</li>
<li><strong>è§£é‡Š</strong>ï¼š
<ul>
<li>ä½ çš„æ¨¡å‹è¾“å‡ºæ˜¯å›ºå®šçš„ $16 \times 16$ ç½‘æ ¼ã€‚</li>
<li><strong>æ—§é€»è¾‘</strong>ï¼šè¾“å…¥ $128 \times 128$ã€‚è¦æŠŠ 128 å‹ç¼©æˆ 16ï¼Œæ¯ä¸ªç½‘æ ¼å°±è¦â€œç®¡â€ $128/16 = \mathbf{8}$ ä¸ªåƒç´ å®½çš„åŒºåŸŸã€‚æ‰€ä»¥æˆ‘ä»¬å¯¹ GT è¿›è¡Œ $8 \times 8$ çš„æ±‚å’Œæ± åŒ–ã€‚</li>
<li><strong>æ–°é€»è¾‘</strong>ï¼šè¾“å…¥ $224 \times 224$ã€‚è¦æŠŠ 224 å‹ç¼©æˆ 16ï¼Œæ¯ä¸ªç½‘æ ¼å°±è¦â€œç®¡â€ $224/16 = \mathbf{14}$ ä¸ªåƒç´ å®½çš„åŒºåŸŸã€‚</li>
<li>å¦‚æœä½ è¾“å…¥ 224 çš„å›¾ï¼Œå´è¿˜æŒ‰ 8å€ä¸‹é‡‡æ ·ç”Ÿæˆ GTï¼Œä½ çš„ GT å°ºå¯¸ä¼šå˜æˆ $224/8 = 28 \times 28$ã€‚</li>
<li><strong>åæœ</strong>ï¼šæ¨¡å‹è¾“å‡º $16 \times 16$ï¼Œæ ‡ç­¾å´æ˜¯ $28 \times 28$ã€‚Loss å‡½æ•°ï¼ˆå¦‚ MSE Lossï¼‰ä¸€è®¡ç®—å°±ä¼šç›´æ¥æŠ¥é”™ï¼š<code>RuntimeError: The size of tensor a (16) must match the size of tensor b (28)</code>ã€‚</li>
</ul>
</li>
</ul>
<p>æ€»ç»“
è¿™ä¸€ç³»åˆ—ä¿®æ”¹çš„æ ¸å¿ƒé€»è¾‘æ˜¯ï¼š
<strong>ç‰µä¸€å‘è€ŒåŠ¨å…¨èº«</strong>ã€‚
ä¸€æ—¦è¾“å…¥å°ºå¯¸å˜äº†ï¼ˆä¸ºäº†é€‚é…æ–°éª¨å¹²ï¼‰ï¼Œè™½ç„¶è¾“å‡ºå°ºå¯¸æƒ³ä¿æŒä¸å˜ï¼ˆä¸ºäº†é€‚é…æ—§åç«¯ï¼‰ï¼Œä½†ä¸­é—´æ‰€æœ‰çš„<strong>åæ ‡æ˜ å°„</strong>ï¼ˆç¿»è½¬ï¼‰ã€<strong>ç©ºé—´æ˜ å°„</strong>ï¼ˆCropï¼‰å’Œ<strong>æ ‡ç­¾æ˜ å°„</strong>ï¼ˆGTç”Ÿæˆï¼‰çš„æ¯”ä¾‹ç³»æ•°å…¨éƒ½è¦è·Ÿç€å˜ã€‚</p>
<p>ä¸åšè¿™äº›ä¿®æ”¹ï¼Œä»£ç è¦ä¹ˆè·‘ä¸èµ·æ¥ï¼ˆæŠ¥é”™ï¼‰ï¼Œè¦ä¹ˆè·‘èµ·æ¥è®­ç»ƒæ•ˆæœæå·®ï¼ˆåæ ‡é”™ä½ï¼‰ã€‚</p>
</blockquote>
<p>è¾“å…¥æå®šäº†ï¼Œæ¥ä¸‹æ¥å°±æ˜¯ä¸­é—´çš„å¯¹æ¥äº†ï¼Œå·²çŸ¥DSU-Netçš„ç‰¹å¾æå–åçš„åˆ†è¾¨ç‡ä¸º<code>11x11</code>ï¼Œè€Œç›®æ ‡åˆ†è¾¨ç‡ä¸º<code>16x16</code>ï¼Œæ•…è€Œéœ€è¦ä¸€ä¸ªé€‚åº”å±‚æ¥è°ƒæ•´åˆ†è¾¨ç‡ã€‚</p>
<p>åœ¨å‚è€ƒäº†aiçš„å»ºè®®åï¼Œæˆ‘å†³å®šä½¿ç”¨<code>RFB+Bilinear</code>çš„æ–¹æ¡ˆï¼Œé€šè¿‡RFBæ¨¡å—è°ƒæ•´é€šé“æ•°ï¼Œåˆ©ç”¨åŒçº¿æ€§æ’å€¼è°ƒæ•´åˆ†è¾¨ç‡ã€‚</p>
<p>å‚è€ƒä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">models.RFB</span> <span class="kn">import</span> <span class="n">RFB_modified</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Adapter_RFB</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_channels</span><span class="o">=</span><span class="mi">1152</span><span class="p">,</span> <span class="n">out_channels</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="n">target_size</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 1. å…ˆç”¨ RFB é™ç»´å¹¶æå–å¤šå°ºåº¦ç‰¹å¾ (1152 -&gt; 256)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># RFB å†…éƒ¨ç»´æŒ spatial size ä¸å˜ (11x11 -&gt; 11x11)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">rfb</span> <span class="o">=</span> <span class="n">RFB_modified</span><span class="p">(</span><span class="n">in_channels</span><span class="p">,</span> <span class="n">out_channels</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># 2. ç©ºé—´å¯¹é½ (11x11 -&gt; 16x16)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">upsample</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Upsample</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">target_size</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;bilinear&#39;</span><span class="p">,</span> <span class="n">align_corners</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rfb</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">upsample</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">x</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="è·‘ä»£ç ">è·‘ä»£ç 
</h2><h2 id="å†™è®ºæ–‡">å†™è®ºæ–‡
</h2><h2 id="å‚è€ƒè®ºæ–‡">å‚è€ƒè®ºæ–‡
</h2><ol>
<li>Xu, Yimin, Fan Yangå’ŒBin Xu. ã€ŠDSU-Net:An Improved U-Net Model Based on DINOv2 and SAM2 with Multi-Scale Cross-Model Feature Enhancementã€‹. arXiv:2503.21187. é¢„å°æœ¬, arXiv, 2025å¹´3æœˆ31æ—¥. <a class="link" href="https://doi.org/10.48550/arXiv.2503.21187"  target="_blank" rel="noopener"
    >https://doi.org/10.48550/arXiv.2503.21187</a>.</li>
<li>Wu, Yihong, Jinqiao Wei, Xionghui Zhao, ç­‰. ã€ŠDSGC-Net: A Dual-Stream Graph Convolutional Network for Crowd Counting via Feature Correlation Miningã€‹. arXiv:2509.02261. é¢„å°æœ¬, arXiv, 2025å¹´9æœˆ2æ—¥. <a class="link" href="https://doi.org/10.48550/arXiv.2509.02261"  target="_blank" rel="noopener"
    >https://doi.org/10.48550/arXiv.2509.02261</a>.</li>
</ol>

</section>


    <footer class="article-footer">
    

    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    </footer>


    
        <link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css"integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI&#43;WdtXRGWt2kTvGFasHpSy3SV"crossorigin="anonymous"
            ><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"integrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG&#43;vnGctmUb0ZY0l8"crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"integrity="sha384-&#43;VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4&#43;/RRE05"crossorigin="anonymous"
                defer
                >
            </script><script>
    window.addEventListener("DOMContentLoaded", () => {
        const elementsToRender = [".main-article", ".widget--toc"];

        elementsToRender.forEach(selector => {
            const element = document.querySelector(selector);
            if (element) {
                renderMathInElement(element, {
                    delimiters: [
                        { left: "$$", right: "$$", display: true },
                        { left: "$", right: "$", display: false },
                        { left: "\\(", right: "\\)", display: false },
                        { left: "\\[", right: "\\]", display: true }
                    ],
                    ignoredClasses: ["gist"]
                });
            }
        });
    });
</script>
    
</article>

    

    

     
    
        
    <script src='https://unpkg.com/@waline/client@v2/dist/waline.js'></script>
<link href='https://unpkg.com/@waline/client@v2/dist/waline.css' rel='stylesheet'/>

<div id="waline-template"></div>
<style>
    .waline-container {
        background-color: var(--card-background);
        border-radius: var(--card-border-radius);
        box-shadow: var(--shadow-l1);
        padding: var(--card-padding);
        --waline-font-size: var(--article-font-size);
    }
    .waline-container .wl-count {
        color: var(--card-text-color-main);
    }
</style><script>
    let classifier = window.location.pathname.replace(/\/$/, '');
    if (classifier.indexOf('/blog/posts') == 0) {
        let _waline_container = document.querySelector('#waline-template');
        _waline_container.id = 'waline';
        _waline_container.className = 'waline-container';

        
        let _waline_config = {"dark":"html[data-scheme=\"dark\"]","el":"#waline","emoji":["https://cdn.jsdelivr.net/gh/walinejs/emojis/bmoji","https://cdn.jsdelivr.net/gh/walinejs/emojis/bilibili","https://cdn.jsdelivr.net/gh/walinejs/emojis/tieba"],"imageUploader":false,"lang":"zh-CN","locale":{"admin":"Admin","placeholder":null},"requiredMeta":["nick","mail"],"serverURL":"https://comment.shaobin-jiang.com"};
        _waline_config.path = classifier;
        Waline.init(_waline_config);
    }
</script>

    

    
<footer class="site-footer">
    <section class="copyright">
        &copy; 
        
        2026 codersgl&#39;s blog
    </section>
    
    <section class="powerby">
        
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >
    

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/blog/ts/main.0db9d3bb15612717eccfcda01bdb204577ec88d4b25414e101d6a0c6df939201.js" defer></script>


    </body>
</html>
